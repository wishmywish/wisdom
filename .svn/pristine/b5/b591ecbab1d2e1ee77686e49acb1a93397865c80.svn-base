<?php

namespace Home\Controller;

use Think\Controller;

class OfficeController extends CommonController {
	private $in_arr; // POST,GET参数数组
	private $userID; // userid
	private $companyId; // companyId
	private $pageSize = 2; //每页显示数
	
	// 删除公告
	public function deleteNotice() {
		$this->init ();
		$json_data = $this->delNotice ();
		//$this->showHtml ( "delNotice", $json_data );
		echo $json_data;
	}
	
	// 删除公告
	public function  setTopMessage() {
		$this->init ();
		$json_data = $this->topMessage ();
		//$this->showHtml ( "delNotice", $json_data );
		echo $json_data;
	}
	
	// 企业通讯录新增客户
	public function addClient() {
		//		$this->init ();
		$this->display ();
	}
	// 企业通讯录客户详情
	public function customerDetails() {
		$this->init ();
		$this->display ();
	}
	
	/* 运营管理入口 */
	public function index() {
		$this->init ();
		// 取得公告列表
		$json_NoticeListdata = $this->getNoticeList (1,"1","6");
		$this->showHtml ( "getNoticeList", $json_NoticeListdata );
		// 取得报告审阅人
		$json_WorkSetdata = $this->getWorkSet ();
		$this->showHtml ( "getWorkSet", $json_WorkSetdata );
		// 预先定义的流程节点处理人
		$reimbursementNodeList = $this->getDefineProcessNodeList(2); // 报销
		$this->showHtml ( "reimbursementNodeList", $reimbursementNodeList );

		$leaveNodeList = $this->getDefineProcessNodeList(3); // 请假
		$this->showHtml ( "leaveNodeList", $leaveNodeList );

		$travelNodeList = $this->getDefineProcessNodeList(4); // 出差
		$this->showHtml ( "travelNodeList", $travelNodeList );

		$costNodeList = $this->getDefineProcessNodeList(1); // 费用
		$this->showHtml ( "costNodeList", $costNodeList );

		// 消息统计
		$messageCount = $this->getMessageCount();
		$this->showHtml ( "messageCount", $messageCount );

		$this->display ();
	}
	
	// 新增公告入口 新增公告画面
	public function noticeAdd() {
		$this->init ();
		if (IS_AJAX) {
			// 追加日报
			echo $this->saveNotice();
		} else {
			$this->showHtml ("queryAllNoticeBoard", $this->queryAllNoticeBoard());
			$this->display ();
		}
	}
	
	// 回复公告入口 回复公告画面
	public function noticeCommentAdd() {
		$this->init ();
		//取得回复状态
		$json_data = $this->getNoticeCommentType ();
		$this->showHtml ( "getNoticeCommentType", $json_data );
		$this->display ();
	}
	
	/* 取得公告详细入口  公告详细画面*/
	public function noticeDetail() {
		$this->init ();
		$json_data = $this->viewNotice ();
		$arr_data = json_decode($json_data, true);
		$arr_data['content'] = html_entity_decode($arr_data['content']);
		$this->assign("notice", $arr_data);
		$json_file_list = json_decode($this->getAttachList(), true);
  		
  		if ($json_file_list 
  			&& $json_file_list['list']
  			&& $json_file_list['list'][0]) {
  			$displayName = $json_file_list['list'][0]['displayName'];
  			$fileUrl = ltrim($json_file_list['list'][0]['fileUrl'], "file="); 
  			$fileUrl = base64_decode($fileUrl);
  			$fileUrl = __ROOT__.'/Public/upfile/'. $fileUrl;
			$this->assign("attach_file_name", $displayName);
			$this->assign("attach_file_url", $fileUrl);
  		}

		$this->display ();
	}
	
	/* 取得用户列表  AJAX*/
	public function userList() {
		$this->init ();
		$json_data = $this->getUserList ();
		echo $json_data;
	}
	
	/* 日报审批人popup画面入口 取得部门树 */
	public function deptList() {
		$this->init ();
		$json_data = $this->getAllDeptList ();
		$this->showHtml ( "getAllDeptList", $json_data );
		$this->display ();
	}
	
	/* 新增日报  日报保存AJAX*/
	public function saveReport() {
		$this->init ();
		// 追加审阅人
		if ($this->in_arr ["recorder"] != "") {
			$this->setWorkSet ();
		}
		// 追加日报
		$json_data = $this->operateWorkReport ();
		echo $json_data;
	}

	/* 新增费用、报销、请假、出差 保存AJAX*/
	public function saveProcess() {
		$this->init ();
		// 追加日报
		$json_data = $this->createProcess ();
		echo $json_data;
	}

	/* 新增消息 保存AJAX*/
	public function saveMessage() {
		$this->init ();
		// 追加消息
		$json_data = $this->sendMessage ();
		echo $json_data;
	}

	// 报告审阅入口文件
	public function reportReview() {
		$this->init ();
		//in_arr ["searchType"];
		//private function queryWorkReport($startDate,$endDate,$type) {
		//echo ($this->in_arr ["selectedDate"]."-01");
		if ($this->in_arr ["selectedDate"] == null or $this->in_arr ["selectedDate"]=="")
		{
			$selectedDate = date("Y-m");
		}else {
			$selectedDate = $this->in_arr ["selectedDate"];
		}
		/*
		if ($this->in_arr ["searchType"]=="1") {
			//$this->assign ( 'selectedDate',date ( "Y-m", strtotime ( "-1 months",$this->in_arr ["selectedDate"]."-01") ));
			$useDate = $this->in_arr ["selectedDate"]."-01";
			$selectedDate = date("Y-m",strtotime("-1months",strtotime($useDate)));
		}else if($this->in_arr ["searchType"]=="2"){
			$useDate = $this->in_arr ["selectedDate"]."-01";
			$selectedDate = date("Y-m",strtotime("+1months",strtotime($useDate)));
			//$this->assign ( 'selectedDate',date("Y-m-d", strtotime("+1 months", strtotime("2010-10-06"))));
		}else if($this->in_arr ["searchType"]=="4"){
			$selectedDate =  $this->in_arr ["selectedDate"];
		}else{
			$selectedDate = date("Y-m");
		}
	*/
		$this->assign ( 'selectedDate',$selectedDate);
		//$type:日报:1;周报:2;月报:3  通过API取得日报
		$json_data=$this->queryWorkReport($selectedDate."-01",date("Y-m-d",strtotime("+1months",strtotime($selectedDate))),"1");
		//将JSON转化为数组
		$json_Array = json_decode ( $this->dejson($json_data ), true );

		//$type:日报:1;周报:2;月报:3  通过API取得周报
		$json_data_weeks = $this->queryWorkReport($selectedDate."-01",date("Y-m-d",strtotime("+1months",strtotime($selectedDate))),"2");
		//将JSON转化为数组
		$json_weeks_Array = json_decode ( $this->dejson($json_data_weeks), true);

		//$type:日报:1;周报:2;月报:3  通过API取得月报
		$json_data_month = $this->queryWorkReport($selectedDate."-01",date("Y-m-d",strtotime("+1months",strtotime($selectedDate))),"3");
		//将JSON转化为数组
		$json_month_Array = json_decode ( $this->dejson($json_data_month), true);

		//循环日报
		$count  =  count($json_Array["list"]);
		$count_weeks = count($json_weeks_Array["list"]);
		$count_month = count($json_month_Array["list"]);
		$reportDate="";
		//当月1号是星期几
		$weekDay = date('w',strtotime($selectedDate."-01"));
		$d = strtotime($selectedDate."-01");
		$days;
		$weeks;
		$month;
		for  ($i=1;  $i<=date('t',$d);  $i++)  {
			$days_value = array("day" => $i,"value" => "","id"=>"");
			$days[$i+$weekDay] = $days_value;
			$weeks[$i+$weekDay] = $days_value;

			if($i == date('t',$d)) {
				if($count_month > 0) {
					$reportDay = date("d",strtotime($reportDate));
					$days_value = array("day" => intval($reportDay, 10),"value" => mb_substr($json_month_Array["list"][0]["content"],0,45, 'utf-8'),"id"=>$json_month_Array["list"][0]["reportId"],"value_t" =>str_replace(" ", '', $json_month_Array["list"][0]["content"]));
					$month[$i+$weekDay] = $days_value;
				}
			} else {
				$month[$i+$weekDay] = $days_value;
			}
		}
		
		for  ($i=0;  $i<$count;  $i++)  {
			//echo $json_Array["list"][$i]["title"]."</br>";
			$reportDate =str_replace(" 工作日报","",$json_Array["list"][$i]["title"]);
			$reportDate =str_replace("日报：","",$reportDate);
			$reportDate =str_replace(" ","",$reportDate);
			//echo $reportDate."</br>";
				
			if ($this->checkDateIsValid($reportDate)){
				//取得日报的日期（只取日）
				$reportDay = date("d",strtotime($reportDate));
				//echo str_replace(" ", '', 	$json_Array["list"][$i]["content"])."</br>";
				//$json_Array["list"][$i]["content"]=substr($json_Array["list"][$i]["content"]['content'],0,50);
				$days_value = array("day" => intval($reportDay, 10),"value" => mb_substr($json_Array["list"][$i]["content"],0,45, 'utf-8'),"id"=>$json_Array["list"][$i]["reportId"],"value_t" =>str_replace(" ", '', 	$json_Array["list"][$i]["content"]));
				//array_push($this->days,$days_value);
				$days[$reportDay+$weekDay] = $days_value;
			}
		}
		
		for($i = 0; $i < $count_weeks; $i++) {
			$weeksDate = str_replace(" 工作周报", "", $json_weeks_Array["list"][$i]["title"]);
			$weeksDate = str_replace("周报：", "", $weeksDate);
			$weeksDate = str_replace(" ", "", $weeksDate);
			$weeksDateList = explode("--", $weeksDate);

			$reportDate = $weeksDateList[1];
				
			if ($this->checkDateIsValid($reportDate)){
				//取得周报的日期（只取日）
				$reportDay = date("d",strtotime($reportDate));
				$days_value = array("day" => intval($reportDay, 10),"value" => mb_substr($json_weeks_Array["list"][$i]["content"],0,45, 'utf-8'),"id"=>$json_weeks_Array["list"][$i]["reportId"],"value_t" =>str_replace(" ", '', $json_weeks_Array["list"][$i]["content"]));
				$weeks[$reportDay+$weekDay] = $days_value;
			}
		}

		if ($this->in_arr ["li_type"]=="li_ri") {
			$startDate = $this->in_arr ["ri_date"];
			$endDate = $this->in_arr ["ri_date"];
		}else if($this->in_arr ["li_type"]=="li_zhou"){
			$startDate = $this->in_arr ["zhou_dateF"];
			$endDate = $this->in_arr ["zhou_dateT"];
		}else if($this->in_arr ["li_type"]=="li_yue"){
			$startDate = $this->in_arr ["yue_date"]."-01";
			$endDate = $this->in_arr ["yue_date"]."-" . date ( "t", strtotime ( $startDate) );
		}else{
			$startDate = $this->in_arr ["startdate"];
			$endDate = $this->in_arr ["endDate"];
		}
		
		//处理审阅日报数据
		//$json_data_WorkReportList=$this->getCheckWorkReportList(date('Y-m-d'),date('Y-m-d'));
		if ($startDate == null){
			$startDate = $selectedDate = date("Y-m-d");
			$endDate = $selectedDate = date("Y-m-d");
		}
		
		//测试数据 开始
		$pageSize = 2;  //每页显示条数。
		//$startDate ="1999-01-01";
		//$endDate ="2999-01-01";
		//测试数据 结束
		
		$this->assign ( 'pageSize',$pageSize);
		$this->assign ( 'total',"0");
		$this->assign ( 'totalPage',"0");
		if ($this->in_arr ["currentPage"]=="" or $this->in_arr ["currentPage"] == null){
			$this->in_arr ["currentPage"] = 1;
		}
		$this->assign ( "currentPage",$this->in_arr ["currentPage"] );
		
		if ($this->in_arr ["deptNames"]== null){
			
		}else
		{
			$this->assign ( 'deptNames', $this->in_arr ["deptNames"]);
		}
		
		if ($this->in_arr ["deptIds"]== null){
				
		}else
		{
			$this->assign ( 'deptIds', $this->in_arr ["deptIds"]);
		}
		
		if ($this->in_arr ["userNames"]== null){
				
		}else
		{
			$this->assign ( 'userNames', $this->in_arr ["userNames"]);
		}
		
		if ($this->in_arr ["userIds"]== null){
				
		}else
		{
			$this->assign ( 'userIds', $this->in_arr ["userIds"]);
		}
	
		$json_data_WorkReportList=$this->getCheckWorkReportList($startDate,$endDate,$pageSize*$this->in_arr ["currentPage"]-1,$this->in_arr ["currentPage"]*$pageSize);
		//$json_data_WorkReportList=$this->queryWorkReport($startDate,$endDate);          // 临时用
		//$this->showHtml ( "WorkReportList", $json_data_WorkReportList );
			
		$json_Array = $this->checkApiResult ( "getCheckWorkReportList", $json_data_WorkReportList );
		$keys = array_keys ( $json_Array );
		
		//审阅报告：1；我的报告：0
		//if ($this->in_arr ["page"]==""   or $this->in_arr ["showDiv"]==null){
		//	$this->assign ( 'showDiv', "0");
		//}else{

		//}
		
		for($i = 0; $i < count ( $keys ); $i ++) {
			// echo $actionName.$keys[$i].' value:'.$json_Array[$keys[$i]].'<br>';
			if ($keys [$i] == "count"){
				$this->assign ( 'total',$json_Array["count"]);
				$this->assign ( 'totalPage',ceil($json_Array["count"]/$pageSize));
			}
			if ($keys [$i] == "list"){
				while(list($key,$value)=each($json_Array["list"]))
				{
					//echo "$key=>".$json_Array["list"][$key]['title'].'<br>';
					if ($json_Array["list"][$key]['type']==null){$json_Array["list"][$key]['type']="　";}
					if ($json_Array["list"][$key]['state']==null){$json_Array["list"][$key]['state']="　";}
					if ($json_Array["list"][$key]['viewTime']==null){$json_Array["list"][$key]['viewTime']="　";}
					if ($json_Array["list"][$key]['createPerple']==null){$json_Array["list"][$key]['createPerple']="　";}
					if ($json_Array["list"][$key]['title']==null){$json_Array["list"][$key]['title']="　";}
					if ($json_Array["list"][$key]['content']==null){$json_Array["list"][$key]['content']="　";}
					if($json_Array["list"][$key]['type']=='1'){
						$json_Array["list"][$key]['type'] = "日报";
						$json_Array["list"][$key]['title'] = mb_substr($json_Array["list"][$key]['title'],3,10, 'utf-8');
					}else if($json_Array["list"][$key]['type']=='2'){
						$json_Array["list"][$key]['type'] = "周报";
						$json_Array["list"][$key]['title'] = mb_substr($json_Array["list"][$key]['title'],15,10, 'utf-8');
					}else{
						$json_Array["list"][$key]['type'] = "月报";
						$json_Array["list"][$key]['title'] = mb_substr($json_Array["list"][$key]['title'],3,7, 'utf-8');
					}
					if($json_Array["list"][$key]['state']=='3'){
						$json_Array["list"][$key]['state'] = "已审阅";
					}else{
						$json_Array["list"][$key]['state'] = "未审阅";
					}
					$json_Array["list"][$key]['title']=mb_substr($json_Array["list"][$key]['title'],0,30, 'utf-8');//substr($json_Array["list"][$key]['title'],0,30);
					$json_Array["list"][$key]['createPerple']=mb_substr($json_Array["list"][$key]['createPerple'],0,10, 'utf-8');//substr($json_Array["list"][$key]['createPerple'],0,30);
					$json_Array["list"][$key]['content']=mb_substr($json_Array["list"][$key]['content'],0,15, 'utf-8');
				}
			}
			$this->assign ( 'getCheckWorkReportList_' . $keys [$i], $json_Array [$keys [$i]] );
		}
		$this->assign ( 'days', $days);
		$this->assign ( 'weeks', $weeks);
		$this->assign ( 'month', $month);
		$this->setReportData ();
		$this->display ();
	}
	
	/* 考勤一览画面入口  考勤列表画面*/
	public function setReportData() {
		 //审阅报告：1；我的报告：0
	    if ($this->in_arr ["showDiv"]=="0"   or $this->in_arr ["showDiv"]==null){
	    	$this->assign ( 'showDiv', "0");
	    }else{
	    	$this->assign ( 'showDiv', "1");
	    }
	   //审阅日报 日 周 月 区间 设置
	    if ($this->in_arr ["li_type"]== null){
	    	$this->assign ( 'li_type', "li_ri");
	    }else 
	    {
	    	$this->assign ( 'li_type', $this->in_arr ["li_type"]);
	    }
	    //审阅日报 日设置
        if ($this->in_arr ["ri_date"] == null){
        	//$this->assign ( 'ri_date', "2015-09-15");
        }else {
        	$this->assign ( 'ri_date',$this->in_arr ["ri_date"]);
        }
        //审阅日报 月设置
        if ($this->in_arr ["yue_date"] == null){
        	//$this->assign ( 'yue_date', "2015-09");
        }else {
        	$this->assign ( 'yue_date',$this->in_arr ["yue_date"]);
        }
        //审阅日报 周设置
        if ($this->in_arr ["zhou_dateF"] == null){
        	//$this->assign ( 'zhou_dateF', "2015-09-15");
        	//$this->assign ( 'zhou_dateT', "2015-09-15");
        }else {
        	$this->assign ( 'zhou_dateF',$this->in_arr ["zhou_dateF"]);
        	$this->assign ( 'zhou_dateT',$this->in_arr ["zhou_dateT"]);
        }
        //审阅日报 区间设置
        if ($this->in_arr ["startdate"] == null){
        	//$this->assign ( 'startdate', "2015-09-15");
        	//$this->assign ( 'enddate', "2015-09-15");
        }else {
        	$this->assign ( 'startdate',$this->in_arr ["startdate"]);
        	$this->assign ( 'enddate',$this->in_arr ["enddate"]);
        }
	}
	
	/* 考勤一览画面入口  考勤列表画面*/
	public function checking() {
		$this->init ();
		$json_data = $this->getWorkSignList(1);
		$this->showHtml ("getWorkSignList", $json_data);
		$this->assign("li_type", $this->in_arr["li_type"]);
		$this->assign("ri_date", $this->in_arr["ri_date"]);
		$this->assign("zhou_dateF", $this->in_arr["zhou_dateF"]);
		$this->assign("zhou_dateT", $this->in_arr["zhou_dateT"]);
		$this->assign("yue_date", $this->in_arr["yue_date"]);
		$this->assign("startdate", $this->in_arr["startdate"]);
		$this->assign("enddate", $this->in_arr["enddate"]);
		$this->assign("deptNames", $this->in_arr["deptNames"]);
		$this->assign("deptIds", $this->in_arr["deptIds"]);
		$this->assign("userNames", $this->in_arr["userNames"]);
		$this->assign("userIds", $this->in_arr["userIds"]);

		$this->display ();
	}
	
	// 公告入口文件
	public function notice() {
		$this->init ();
		// 追加日报
		$json_data = $this->getNoticeList(1);
		$this->showHtml ( "getNoticeList", $json_data );
		$json_data = $this->queryAllNoticeBoard();
		$this->showHtml ( "queryAllNoticeBoard", $json_data );
		$this->display ();
	}

	// 工作审批入口文件
	public function approval() {
		$this->init ();
		// 报销列表
		$reimbursement_list = $this->getApprovalList(2, 1);
		// 请假列表
		$leave_list = $this->getApprovalList(3, 1);
		// 出差列表
		$businessTrip_list = $this->getApprovalList(4, 1);
		// 费用列表
		$cost_list = $this->getApprovalList(1, 1);

		$this->assign ("reimbursement_list", $reimbursement_list);
		$this->assign ("leave_list", $leave_list);
		$this->assign ("businessTrip_list", $businessTrip_list);
		$this->assign ("cost_list", $cost_list);
		$this->display ();
	}

	// 消息入口文件
	public function message() {
		$this->init ();
		$message_list = $this->queryMessageList(1);
		$this->assign ("message_list", $message_list);
		$this->display ();
	}
	
	// 通讯录入口文件
	public function contact() {
		$this->init ();
		$dept_list = $this->formatDeptList(true);
		$user_list = $this->getUserList(1);
		$customer_list = $this->getCustomerList(1);
		$this->assign ("dept_list", $dept_list);
		$this->assign ("user_list", $user_list);
		$this->assign ("customer_list", $customer_list);
		$this->display ();
	}

	public function showUserDetail($uid) {
		$userDetail = $this->viewUserDetail($uid);
		$this->assign("userDetail", json_decode($userDetail, true));
		$this->display ();
	}

	/* 取得全部消息 */
	public function getInfoAll() {
		// $json_data = $this->operateWorkReport ();
		// $this->showHtml("operateWorkReport",$json_data);
		// $this->display();
	}
	
	/* 取得待处理消息 */
	public function getInfoBefore() {
		// $json_data = $this->operateWorkReport ();
		// $this->showHtml("operateWorkReport",$json_data);
		// $this->display();
	}
	
	/* 取得处理后消息 */
	public function getInfoAfter() {
		// $json_data = $this->operateWorkReport ();
		// $this->showHtml("operateWorkReport",$json_data);
		// $this->display();
	}
	
	/* 初期化 */
	private function init() {
		set_theme ();
		$re = A ( 'Api' )->getBigC ();
		// pt($re);
		// exit;
		foreach ( $re as $key => $val ) {
			if ($val ['f_sys_column_cid'] == 'Office') {
				$syscolumn_id = $val ['f_syscolumn_id'];
				$sre = A ( 'Api' )->getBigC ( $syscolumn_id );
			}
		}
		
		$this->assign ( 'bigclass', $re );
		$this->assign ( 'smallclass', $sre );
		// $this->display();
		
		$this->in_arr = array_merge ( $_GET, $_POST );
		$this->userID = cookie ( "userId" );
		$this->companyId = cookie ( "companyId" );
		//取得用户基本信息
		$json_data = $this->viewUserDetail();
		$this->showHtml ( "viewUserDetail", $json_data );
	}
	
	/* 为HTML返回数据 */
	private function showHtml($actionName, $json_data) {
		$json_Array = $this->checkApiResult ( $actionName, $json_data );
		$keys = array_keys ( $json_Array );
		for($i = 0; $i < count ( $keys ); $i ++) {
			// echo $actionName.$keys[$i].' value:'.$json_Array[$keys[$i]].'<br>';
			$this->assign ( $actionName . '_' . $keys [$i], $json_Array [$keys [$i]] );
		}
	}
	
	/*
	 * 调用API saveAttach 10.1 新增附件记录接口
	 * tblname 附件所属业务名称 公告附件:bbsMessage; 工作报告附件:workReport;
	 * linkid 附件所属业务ID    公告ID或工作报告ID
	 * oldName 附件名称
	 * type 附件类型
	 * size 附件大小
	 * returnUrl 附件存储路径加密文本
	 */
	private function saveAttach($tblname,$linkid,$oldName,$type,$size,$returnUrl) {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "saveAttach",
				"tblname" => $tblname,
				"linkid" => $linkid,
				"oldName" => $oldName,
				"type" => $type,
				"size" => $size,
				"returnUrl" => "file=".base64_encode($returnUrl)
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/* 调用delNotice 1.4删除公告接口 */
	private function delNotice() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "delNotice",
				"userId" =>$this->userID,
				"messageId" =>$this->in_arr ["messageId"] 
		);
		
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/* 调用topMessage 1.8公告置顶操作接口 */
	private function topMessage() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "topMessage",
				"userId" =>$this->userID,
				"isTop" =>$this->in_arr ["isTop"],
				"messageId" =>$this->in_arr ["messageId"]
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}

	/* 调用API getDefineProcessNodeList 预先定义的流程节点处理人 */
	private function getDefineProcessNodeList($busiType = 1) {

		$this->init ();
		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "getDefineProcessNodeList",
				"userId" => $this->userID,
				"busiType" => $busiType,
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/* 调用API getAllDeptList 返回部门列表 */
	private function getAllDeptList() {
		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "getAllDeptList",
				"companyId" => $this->companyId
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}

	private function getDictByCondition() {
		$url = C ( "OperatehttpUrl" ) . $url;
	
		$data = array (
				"command" => "getDictByCondition",
				"companyId" => $this->companyId,
				"type" => "1"
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	private function getAreaList() {
		$url = C ( "OperatehttpUrl" ) . $url;
	
		$data = array (
				"command" => "getAreaList",
				"companyId" => $this->companyId,
				"userId" => "10063"
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}

	/* 报销流程详情 */
	public function showApplyDetail() {
		$this->init ();
		// 报销详情
		$apply_detail = $this->getApprovalDetail();
		$this->assign ("apply_detail", $apply_detail);
		$this->assign ("userId", $this->userID);
		$this->assign ("page", $this->in_arr ["page"]);
    	$this->display();
	}

	/* 添加回复或评论 */
	public function replyMessage() {
		$this->init ();
		$this->assign ("mesId", $this->in_arr ["mesId"]);
		$this->assign ("commentId", $this->in_arr ["commentId"]);
		$this->assign ("replyToUserId", $this->in_arr ["replyToUserId"]);
    	$this->display();
	}

	/* 请假流程详情 */
	public function showLeaveDetail() {
		$this->init ();
		// 请假详情
		$leave_detail = $this->getApprovalDetail();
		$this->assign ("leave_detail", $leave_detail);
		$this->assign ("userId", $this->userID);
		$this->assign ("page", $this->in_arr ["page"]);
    	$this->display();
	}

	/* 出差流程详情 */
	public function showTravelDetail() {
		$this->init ();
		// 出差详情
		$travel_detail = $this->getApprovalDetail();
		$this->assign ("travel_detail", $travel_detail);
		$this->assign ("userId", $this->userID);
		$this->assign ("page", $this->in_arr ["page"]);
    	$this->display();
	}

	/* 费用流程详情 */
	public function showFeeDetail() {
		$this->init ();
		// 费用详情
		$fee_detail = $this->getApprovalDetail();
		$this->assign ("fee_detail", $fee_detail);
		$this->assign ("userId", $this->userID);
		$this->assign ("page", $this->in_arr ["page"]);
    	$this->display();
	}

	/* 我的日志-工作报告详情 */
	public function showReport() {
		$this->init ();
		// 工作报告详情
		$work_report = $this->viewWorkReport();
		$this->assign ("work_report", $work_report);
		// 获取工作报告审阅人
		$work_set = $this->getWorkSet();
		$this->assign ("work_set", json_decode($work_set, true));
		// 获取工作报告附件
		$attach_list = $this->getAttachListReport();
		$this->assign ("attach_list", $attach_list);

    	$this->display();
	}

	/* 日志审阅-工作报告详情 */
	public function showReportReviewDetail() {
		$this->init ();
		// 工作报告详情
		$work_report = $this->viewWorkReport();
		$this->assign ("work_report", $work_report);
		// 获取工作报告审阅人
		$work_set = $this->getWorkSet();
		$this->assign ("work_set", json_decode($work_set, true));
		// 获取工作报告附件
		$attach_list = $this->getAttachListReport();
		$this->assign ("attach_list", $attach_list);

		$this->assign ("reportID", $this->in_arr ["reportID"]);
    	$this->display();
	}

	/* 日志审阅-审批提交 */
	public function saveWorkReportComment() {
		$this->init ();
		// 工作报告查阅接口 set state = 3
		$work_report = $this->checkWorkReport();
		// 工作报告新增评论接口
		$work_report_coment = $this->saveWorkReportComent();

		echo $work_report_coment;
	}

	/* 调用API saveWorkReportComent 工作报告新增评论接口 */
	public function saveWorkReportComent() {
		$this->init ();

		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "saveWorkReportComent",
				"userId" => $this->userID,
				"reportId" => $this->in_arr ["reportID"],
				"content" => $this->in_arr ["content"],
		);
		$json_data = postData ( $url, $data );

		// $arr_data = json_decode($json_data, true);
		return $json_data;
	}

	/* 调用API checkWorkReport 工作报告查阅接口 */
	public function checkWorkReport() {
		$this->init ();

		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "checkWorkReport",
				"eid" => $this->userID,
				"wid" => $this->in_arr ["reportID"],
		);
		$json_data = postData ( $url, $data );

		// $arr_data = json_decode($json_data, true);
		return $json_data;
	}

	/* 调用API viewWorkReport 返回工作报告详情 */
	public function viewWorkReport() {
		$this->init ();

		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "viewWorkReport",
				"userId" => $this->userID,
				"reportId" => $this->in_arr ["reportID"],
		);
		$json_data = postData ( $url, $data );

		$arr_data = json_decode($json_data, true);
		return $arr_data;
	}

	/* 调用API viewProcessDetail 返回流程详情 */
	public function getApprovalDetail() {
		$this->init ();

    	$processId = $this->in_arr ["processId"];

		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "viewProcessDetail",
				"userId" => $this->userID,
				"processId" => $processId,
		);
		$json_data = postData ( $url, $data );

		$arr_data = json_decode($json_data, true);
		return $arr_data;
	}

	/* 调用API processNodeApproval 流程节点审批接口(同意/拒绝/转发) */
	public function processNodeApproval() {
		$this->init ();
		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "processNodeApproval",
				"userId" => $this->userID,
				"processId" => $this->in_arr ["processId"],
				"processNodeId" => $this->in_arr ["processNodeId"],
				"operateType" => $this->in_arr ["operateType"],
				"forwardHandleUserId" => $this->in_arr ["forwardHandleUserId"],
				"comment" => $this->in_arr ["comment"],
		);
		$json_data = postData ( $url, $data );

		echo $json_data;
	}

	/* 调用API queryMessageList 查询消息列表 */
	public function queryMessageList($page = 1) {

		$this->init ();
		$this->pageSize = 3;

		$queryStart = (($page - 1) * $this->pageSize) + 1;
		$queryEnd = $page * $this->pageSize;

		// 范围
		$type = $this->in_arr ["type"];
		if($type == "" || $type == 0) {
			$type = 1;
		}

		// 部门ID
		$deptId = "";
		if($type == 1) {
			$deptId = cookie('departId');
		}

		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "queryMessageList",
				"userId" => $this->userID,
				"companyId" => $this->companyId,
				"queryStart" => $queryStart,
				"queryEnd" => $queryEnd,
				"type" => $type,
				"deptId" => $deptId,
				"startDate" => $this->in_arr ["startDate"],
				"endDate" => $this->in_arr ["endDate"],
		);
		$json_data = postData ( $url, $data );

		if ($page > 0) {
			$obj_data = json_decode($this->dejson($json_data ));
			$pages = $this->getPages(intval($obj_data->messageCount));
			$obj_data->page = $page;
			$obj_data->total = $pages['total'];
			$obj_data->pageSize = $pages['pageSize'];
			$obj_data->totalPage = $pages['totalPage'];
			$json_data = json_encode($obj_data);
		}

		if (IS_AJAX) {
			echo $json_data;
		} else {
			$arr_data = json_decode($json_data, true);
			return $arr_data;
		}
	}

	/* 调用API getProcessList 返回流程列表 */
	public function getApprovalList($busiType = 1, $page = 1) {
		$this->init ();

		$this->pageSize = 10;

		$queryStart = (($page - 1) * $this->pageSize) + 1;
		$queryEnd = $page * $this->pageSize;

		// 流程列表数据类型
		$type = $this->in_arr ["type"];
		if($type == "" || $type == 0) {
			$type = 1;
		}

		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "getProcessList",
				"userId" => $this->userID,
				"queryStart" => $queryStart,
				"queryEnd" => $queryEnd,
				"type" => $type,
				"busiType" => $busiType,
				"status" => $this->in_arr ["status"],
				"startDate" => $this->in_arr ["startDate"],
				"endDate" => $this->in_arr ["endDate"],
		);
		$json_data = postData ( $url, $data );

		if ($page > 0) {
			$obj_data = json_decode($this->dejson($json_data ));
			$pages = $this->getPages(intval($obj_data->count));
			$obj_data->page = $page;
			$obj_data->total = $pages['total'];
			$obj_data->pageSize = $pages['pageSize'];
			$obj_data->totalPage = $pages['totalPage'];
			$json_data = json_encode($obj_data);
		}

		if (IS_AJAX) {
			echo $json_data;
		} else {
			$arr_data = json_decode($json_data, true);
			return $arr_data;
		}
	}

	/* 调用API getCustomerList 取得客户列表 */
	private function getCustomerList($page = 0) {
		$this->init ();
		if ($page > 0) {
			$queryStart = (($page - 1) * $this->pageSize) + 1;
			$queryEnd = $page * $this->pageSize;
		} else {
			$queryStart = 1;
			$queryEnd = 100000;
		}

		$url = C ( "OperatehttpUrl" ) . $url;

		$data = array (
				"command" => "searchCustomer",
				"userId" => $this->userID,
				"searchType" => 1,
				"queryStart" => $queryStart,
				"queryEnd" => $queryEnd,
		);
		$json_data = postData ( $url, $data );

		if ($page > 0) {
			$obj_data = json_decode($this->dejson($json_data ));
			$pages = $this->getPages(intval($obj_data->count));
			$obj_data->page = $page;
			$obj_data->total = $pages['total'];
			$obj_data->pageSize = $pages['pageSize'];
			$obj_data->totalPage = $pages['totalPage'];
			$json_data = json_encode($obj_data);
		}

		if (IS_AJAX) {
			echo $json_data;
		} else {
			$arr_data = json_decode($json_data, true);
			return $arr_data;
		}
	}

	/* 调用API deleteCustomer 删除选中客户 */
	public function deleteCustomer() {
		$this->init ();
		$ids = $this->in_arr ["ids"];
		$page = $this->in_arr ["page"];

		if ($page > 0) {
			$queryStart = (($page - 1) * $this->pageSize) + 1;
			$queryEnd = $page * $this->pageSize;
		} else {
			$queryStart = 1;
			$queryEnd = 100000;
		}

		$url = C ( "OperatehttpUrl" ) . $url;

		// 删除顾客
		$id_list = explode(",", $ids);
		foreach($id_list as $value) {
			$data = array(
				"command" => "delCustomer",
				"cusId" => $value,
				"userId" => $this->userID,
				);
			$json_data = postData ( $url, $data );
		}

		// 查询顾客列表
		$data = array (
				"command" => "searchCustomer",
				"userId" => $this->userID,
				"searchType" => 1,
				"queryStart" => $queryStart,
				"queryEnd" => $queryEnd,
		);
		$json_data = postData ( $url, $data );

		if ($page > 0) {
			$obj_data = json_decode($this->dejson($json_data ));
			$pages = $this->getPages(intval($obj_data->count));
			$obj_data->page = $page;
			$obj_data->total = $pages['total'];
			$obj_data->pageSize = $pages['pageSize'];
			$obj_data->totalPage = $pages['totalPage'];
			$json_data = json_encode($obj_data);
		}
		echo $json_data;
	}
	
	/* 调用API getUserList 取得登陆用户所属公司下的员工列表 */
	public function getUserList($page = 0) {
		$this->init ();
		if ($page > 0) {
			$queryStart = (($page - 1) * $this->pageSize) + 1;
			$queryEnd = $page * $this->pageSize;
		} else {
			$queryStart = 1;
			$queryEnd = 100000;
		}

		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "getUserList",
				"userId" => $this->userID,
				"queryStart" => $queryStart,
				"queryEnd" => $queryEnd,
				"deptId" => $this->in_arr ["deptId"],
				"userName" => $this->in_arr["name"],
				"mobile" => $this->in_arr["mobile"],
		);
		$json_data = postData ( $url, $data );

		if ($page > 0) {
			$obj_data = json_decode($this->dejson($json_data ));
			$pages = $this->getPages(intval($obj_data->count));
			$obj_data->page = $page;
			$obj_data->total = $pages['total'];
			$obj_data->pageSize = $pages['pageSize'];
			$obj_data->totalPage = $pages['totalPage'];
			$json_data = json_encode($obj_data);
		}

		if (IS_AJAX) {
			echo $json_data;
		} else {
			$arr_data = json_decode($json_data, true);
			return $arr_data;
		}
	}
	
	/* 调用API getWorkSet 取得审阅人 */
	private function getWorkSet() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "getWorkSet",
				"userId" => $this->userID 
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/* 调用API saveWorkSet 设置审阅人 */
	private function setWorkSet() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "saveWorkSet",
				"userId" => $this->userID,
				"recorder" => $this->in_arr ["recorder"] 
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/* 调用API getNoticeList 取得公告列表 */
	private function getNoticeList($page=1, $queryStart_Para="",$queryEnd_Para="") {
		$url = C ( "OperatehttpUrl" ) . $url;
		
		if ($this->in_arr["page"]) {
			$page = intval($this->in_arr["page"]);
		} else if (!$page) {
			$page = 1;
		}

		$queryStart = "";
		$queryEnd = "";
		if($queryStart_Para == "") {
			$queryStart = (($page - 1) * $this->pageSize) + 1;
			$queryEnd = $page * $this->pageSize;
		} else{
			$queryStart = $queryStart_Para;
			$queryEnd = $queryEnd_Para;
		}
		$data = array (
				"command" => "getNoticeList",
				"userId" => $this->userID,
				"companyId" => $this->companyId,
				"queryStart" => $queryStart,
				"queryEnd" => $queryEnd,
				"subject" => $this->in_arr ["subject"],
				"boardId" => $this->in_arr ["boardId"]
		);
		$json_data = postData ( $url, $data );
		$obj_data = json_decode($this->dejson($json_data ));
		$pages = $this->getPages(intval($obj_data->count));
		$obj_data->page = $page;
		$obj_data->total = $pages['total'];
		$obj_data->pageSize = $pages['pageSize'];
		$obj_data->totalPage = $pages['totalPage'];
		return json_encode($obj_data);
	}

	/* 调用API getNoticeList 取得公告列表 */
	public function searchNoteList() {
		$this->init();
		echo $this->getNoticeList();
	}
	
	/* 调用API viewNotice 取得公告明细 */
	private function viewNotice() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "viewNotice",
				"userId" => $this->userID,
				"companyId" => $this->companyId,
				"messageId" => $this->in_arr ["messageId"] 
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	
	/* 调用API getCheckWorkReportList  审阅工作报告列表（不含自己） */
	private function getCheckWorkReportList($startDate,$endDate,$queryStart=0,$queryEnd=999) {
		/*
		command	请求命令
		userId			用户ID
		queryStart	查询范围下限
		queryEnd	查询范围上限
		title				报告标题
		startDate		报告开始日期
		endDate		报告结束日期
		type				报告类型          日报:1;周报:2;月报:3
		state			报告状态          未审阅:2;已审阅:3
		*/
		
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "getCheckWorkReportList",
				"userId" => $this->userID,
				"queryStart" => $queryStart,
				"queryEnd" => $queryEnd,
				"startDate" =>$startDate,
				"endDate" => $endDate,
				"userIds" => $userIds,
				"deptIds" => $deptIds,
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/* 调用API queryGPSList 3.1获取拜访签到列表 */
	private function queryGPSList() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "queryGPSList",
				"userId" => $this->userID,
				"companyId" => $this->companyId,
				"messageId" => $this->in_arr ["messageId"] 
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	// 2.8工作报告查询接口  queryWorkReport
	private function queryWorkReport($startDate,$endDate,$type="") {
		/*
			command	String	Y	V64	请求命令
			userId	String	Y	V16	用户ID
			queryStart	String	Y	V16	查询范围下限
			queryEnd	String	Y	V16	查询范围上限
			title	String	N	V2	报告标题
			startDate	String	N	V16	报告开始日期
			endDate	String	N	V16	报告结束日期
			type	String	N	V2	报告类型
			state	String	N	V2	报告状态
			*/
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "queryWorkReport",
				"userId" => $this->userID,
				"queryStart"	=> "0",
				"queryEnd"	=> "9999",
				"startDate" =>$startDate,
				"endDate" =>$endDate,
				"type" =>$type
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	/*取得日报ID*/
	private function getWorkReportId() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "getWorkReportId" 
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	/*getNoticeCommentType 1.9查询公告反馈类型列表接口*/
	private function getNoticeCommentType() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "getNoticeCommentType",
				"companyId" => $this->companyId
				
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	
	/*viewUserDetail 4.3 查看用户详情接口*/
	private function viewUserDetail($uid = 0) {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "viewUserDetail",
				"userId" => (empty($uid) ? $this->userID : $uid)
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/*queryAllNoticeBoard 9.2 查询公告栏目接口*/
	private function queryAllNoticeBoard() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "queryAllNoticeBoard",
				"userId" => $this->userID,
	
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/*取得公告ID*/
	private function getNoticeId() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "getNoticeId"
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/* 3.4查询上下班签到记录 getWorkSignList */
	private function getWorkSignList($page=1) {
		$url = C ( "OperatehttpUrl" ) . $url;
		if ($this->in_arr["page"]) {
			$page = intval($this->in_arr["page"]);
		} else if (!$page) {
			$page = 1;
		}

		$queryStart = (($page - 1) * $this->pageSize) + 1;
		$queryEnd = $page * $this->pageSize;
		$dateType = 1;
		switch ($this->in_arr["li_type"]) {
			case 'li_zhou':
				$dateType = 2;
				$startDate = $this->in_arr ["zhou_dateF"];
				$endDate = $this->in_arr ["zhou_dateT"];
				break;
			case 'li_yue':
				$dateType = 3;
				$startDate = $this->in_arr ["yue_date"];
				$endDate = "";
				break;
			case 'li_qujian':
				$dateType = 4;
				$startDate = $this->in_arr ["startdate"];
				$endDate = $this->in_arr ["enddate"];
				break;
			default:
				$dateType = 1;
				$startDate = $this->in_arr ["ri_date"];
				$endDate = $this->in_arr ["ri_date"];
				break;
		}
		
		$data = array (
				"command" => "getWorkSignList",
				"userId" => $this->userID,
				"queryStart" => $queryStart,
				"queryEnd" => $queryEnd,
				"source" => "1",
				"dateType" => $dateType,
				"startDate" => $startDate,
				"endDate" => $endDate,
				"userIds" => $this->in_arr ["userIds"],
				"deptId" => $this->in_arr ["deptId"] 
		);

		$json_data = postData ( $url, $data );
		$obj_data = json_decode($this->dejson($json_data));
		$pages = $this->getPages(intval($obj_data->count));
		$obj_data->page = $page;
		$obj_data->total = $pages['total'];
		$obj_data->pageSize = $pages['pageSize'];
		$obj_data->totalPage = $pages['totalPage'];
		return json_encode($obj_data);
	}
	

	/* 调用API saveNotice 1.1新增公告接口 */
	private function saveNotice() {
	
		$json_data = $this->getNoticeId ();
		$json_Array = json_decode ( $this->dejson($json_data ), true );
		$noticeId = $json_Array ["noticeId"]; 
		$subject  = $this->in_arr ["subject"];
		$content = htmlentities($this->in_arr ["content"]);
		$path = 'http://' . I('server.HTTP_HOST') . U('Home/Office/noticeDetail', array('messageId' => $noticeId));
		$boardId = $this->in_arr ["boardId"];
		$userIds = $this->in_arr ["userIds"];
		$deptIds = $this->in_arr ["deptIds"];
		$isTop = $this->in_arr ["isTop"];
	
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "saveNotice",
				"noticeId" => $noticeId,
				"userId" => $this->userID,
				"subject" => $subject,
				"content" => $content,
				"path" => $path,
				"boardId" => $boardId,
				"userIds" => $userIds,
				"deptIds" => $deptIds,
				"isTop" => $isTop
		);
		$json_data = postData ( $url, $data );
		
		//notice 附件追加
		if ($upfile['oldName']!="" && $upfile['oldName']!=null){
			$json_data_saveAttach = $this->saveAttach("bbsMessage",$noticeId,$upfile['oldName'],$upfile['type'],$upfile['size'],$upfile['returnUrl']);
			$json_data_updateNoticeAttachFlag = $this->updateNoticeAttachFlag(1,$noticeId);
		}
		return $json_data;
	}
	
	/* 调用API updateNoticeAttachFlag 1.2修改公告附件标识接口*/
	private function updateNoticeAttachFlag($flag,$messageId) {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "updateNoticeAttachFlag",
				"flag" => $flag,
				"messageId" => $messageId,
		);
		$json_data = postData ( $url, $data );
	
		return $json_data;
	}
	
	/* 调用API updateAttachFlag 2.5修改工作报告附件标识接口*/
	private function updateAttachFlag($flag, $reportId) {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "updateAttachFlag",
				"flag" => $flag,
				"reportId" => $reportId,
		);
		$json_data = postData ( $url, $data );
	
		return $json_data;
	}
	
	/* 调用API operateWorkReport  追加修改日报*/
	private function operateWorkReport() {
		$json_data = $this->getWorkReportId ();
		$json_Array = json_decode ( $this->dejson($json_data ), true );
		$command = "operateWorkReport"; // 请求命令
		$userId = $this->userID; // 用户ID
		$source = "1"; // 来源 web:1;mobile:2
		$reportId = $json_Array ["reportId"]; // 工作报告ID
		$reportType = $this->in_arr ["reportType"]; // 工作报告类型 日报:1;周报:2;月报:3
		$startDate = $this->in_arr ["startDate"]; // 工作报告开始时间 可以为空
		$endDate = $this->in_arr ["endDate"]; // 工作报告结束时间 可以为空
		$subject = ""; // 工作报告标题 可以为空 标题格式(日报：年-月-日 工作日报);周报格式(周报：年-月-日--年-月-日 工作周报);月报格式(月报：年-月 工作月报).
		$oType = "1"; // 操作类型 新增:1;编辑:2.
		$voiceCount = "0"; // 工作报告语音条数 可以为空 最多5条  web端无法使用该接口上传附件
		$reportState = "2"; // 工作报告提交审核或保存1,保存,2 提交审核
		$reportContent = $this->in_arr ["reportContent"]; // 工作报告内容
		$voices = $this->in_arr ["voices"];
		$url = C ( "OperatehttpUrl" ) . $url;
		if ($reportType == "1") {
			$startDate = $this->in_arr ["date"];
			$endDate = $this->in_arr ["date"];
			$subject = "日报：" . $startDate . "  工作日报";
		} elseif ($reportType == "2") {
			$subject = "周报：" . $startDate . "--" . $endDate . "  工作周报";
		} elseif ($reportType == "3") {
			$subject = "月报：" . date ( "Y-m", strtotime ( $this->in_arr ["date"] ) ) . "  工作月报";
			$startDate = date ( "Y-m", strtotime ( $this->in_arr ["date"] ) ) . "-01";
			$endDate = date ( "Y-m", strtotime ( $this->in_arr ["date"] ) ) . "-" . date ( "t", strtotime ( $this->in_arr ["date"] ) );
		}
		
		$json_data = $this->getWorkReportId ();
		$json_Array = json_decode ( $this->dejson($json_data ), true );
		
		$data = array (
				"command" => $command,
				"userId" => $userId,
				"source" => $source,
				"reportId" => $reportId,
				"reportType" => $reportType,
				"startDate" => $startDate,
				"endDate" => $endDate,
				"subject" => $subject,
				"oType" => $oType,
				"voiceCount" => $voiceCount,
				"reportState" => $reportState,
				"reportContent" => $reportContent,
		);
		
		//追加附件
		$oldName = $this->in_arr ['oldName'];
		$type = $this->in_arr ['type'];
		$size = $this->in_arr ['size'];
		$returnUrl = $this->in_arr ['returnUrl'];

		if ($oldName != "" && $oldName != null) {
			$oldNameList = explode(",", $oldName);
			$typeList = explode(",", $type);
			$sizeList = explode(",", $size);
			$returnUrlList = explode(",", $returnUrl);

			for($i = 0; $i < count($oldNameList); $i ++) {
				// 新增附件记录接口
				$this->saveAttach("workReport", $reportId, $oldNameList[$i], $typeList[$i], $sizeList[$i], $returnUrlList[$i]);
			}
			// 修改公告附件标识接口
			$this->updateAttachFlag(1, $reportId);	
		}

		$json_data = postData ( $url, $data );
		return $json_data;
	}

	/* 调用API createProcess  创建流程接口*/
	private function createProcess() {
		$command = "createProcess"; // 请求命令
		$userId = $this->userID; // 用户ID
		$companyId = $this->companyId; // 企业ID
		$busiType = $this->in_arr ["busiType"]; // 1.费用;2.报销;3.请假;4.出差
		$status = 2; // 流程状态 1.未提交;2.待处理;3.审核通过;4.审核不通过(流程创建后状态为2)
		$attachPath = $this->in_arr ["returnUrl"]; // 流程附件存储路径

		$userRecorder = ""; // 审批人员
		if($busiType == 1) {
			$userRecorder = $this->in_arr ["users7recorder"];
		}
		if($busiType == 2) {
			$userRecorder = $this->in_arr ["users4recorder"];
		}
		if($busiType == 3) {
			$userRecorder = $this->in_arr ["users5recorder"];
		}
		if($busiType == 4) {
			$userRecorder = $this->in_arr ["users6recorder"];
		}

		if($userRecorder == "") {
			$approvalCount = 0; // 自定义初始审批节点数量
			$processNodes = array(); // 审批节点集合
		} else {
			$approvalCount = count($userRecorder); // 自定义初始审批节点数量
			// 审批节点集合
			foreach($userRecorder as $key => $value) {
				$i = $key + 1;
				$processNodes["node".$i] = array("nodeHandlerPerson" => $value);
			}
		}

		$formInfo = array(); // 表单信息集合

		if($busiType == 1) {
			$formInfo['costType'] = $this->in_arr ["costType"]; // 费用类型
			$formInfo['money'] = $this->in_arr ["money"]; // 金额
		}
		if($busiType == 2) {
			$formInfo['reimbursementType'] = $this->in_arr ["reimbursementType"]; // 报销类型
			$formInfo['money'] = $this->in_arr ["money"]; // 金额
		}
		if($busiType == 3) {
			$formInfo['leaveType'] = $this->in_arr ["leaveType"]; // 请假类型
			$formInfo['days'] = $this->in_arr ["days"]; // 请假/出差天数
			$formInfo['beginDate'] = $this->in_arr ["beginDate"]; // 开始日期
			$formInfo['endDate'] = $this->in_arr ["endDate"]; // 结束日期
		}
		if($busiType == 4) {
			$formInfo['address'] = $this->in_arr ["address"]; // 出差地点
			$formInfo['days'] = $this->in_arr ["days"]; // 请假/出差天数
			$formInfo['beginDate'] = $this->in_arr ["beginDate"]; // 开始日期
			$formInfo['endDate'] = $this->in_arr ["endDate"]; // 结束日期
		}
		$formInfo['content'] = $this->in_arr ["content"]; // 表单内容

		$data = array (
				"command" 		=> $command,
				"userId" 		=> $userId,
				"companyId" 	=> $companyId,
				"busiType" 		=> $busiType,
				"status" 		=> $status,
				"attachPath" 	=> $attachPath,
				"approvalCount" => $approvalCount,
				"processNodes" 	=> $processNodes,
				"formInfo" 		=> $formInfo,
		);

		$url = C ( "OperatehttpUrl" ) . $url;

		$json_data = postData ( $url, $data );


		// 预先定义的流程节点处理人
		$defineNodeList = $this->getDefineProcessNodeList($busiType);
		$nodeList = json_decode($this->dejson($defineNodeList));

		$obj_data = json_decode($this->dejson($json_data));
		$obj_data->nodeList = $nodeList->userList;
		$json_data = json_encode($obj_data);

		return $json_data;
	}

	/* 调用API getMessageCount  消息统计*/
	private function getMessageCount() {

		$command = "getMessageCount"; // 请求命令
		$userId = $this->userID; // 用户ID
		$companyId = $this->companyId; // 企业ID
		$deptId = cookie('departId'); // 部门ID

		$data = array (
				"command" 	  => $command,
				"userId" 	  => $userId,
				"companyId"	  => $companyId,
				"deptId" 	  => $deptId,
		);

		$url = C ( "OperatehttpUrl" ) . $url;

		$json_data = postData ( $url, $data );
		return $json_data;
	}
	
	/* 调用API sendMessage  发送消息接口*/
	private function sendMessage() {
		$command = "sendMessage"; // 请求命令
		$userId = $this->userID; // 用户ID
		$companyId = $this->companyId; // 企业ID
		$content = $this->in_arr ["content"]; // 消息内容
		$deptIds = $this->in_arr ["deptIds"]; // 消息发送的部门ID串
		$attachPaths = $this->in_arr ["attachPaths"]; // 流程附件存储路径
		$userIds = $this->in_arr ["userIds"]; // @的用户ID串

		$data = array (
				"command" 	  => $command,
				"userId" 	  => $userId,
				"companyId"	  => $companyId,
				"content" 	  => $content,
				"deptIds"	  => $deptIds,
				"attachPaths" => $attachPaths,
				"userIds" 	  => $userIds,
		);

		$url = C ( "OperatehttpUrl" ) . $url;

		$json_data = postData ( $url, $data );

		return $json_data;
	}

	/* 调用API addComment  添加评论接口*/
	public function addComment() {
		$this->init();
		$command = "addComment"; // 请求命令
		$userId = $this->userID; // 用户ID
		$companyId = $this->companyId; // 企业ID
		$commentContent = $this->in_arr ["commentContent"]; // 评论内容
		$mesId = $this->in_arr ["mesId"]; // 消息ID

		$data = array (
				"command" 	  	 => $command,
				"userId" 	  	 => $userId,
				"companyId"	  	 => $companyId,
				"commentContent" => $commentContent,
				"mesId"	  		 => $mesId,
		);

		$url = C ( "OperatehttpUrl" ) . $url;

		$json_data = postData ( $url, $data );

		if (IS_AJAX) {
			echo $json_data;
		} else {
			$arr_data = json_decode($json_data, true);
			return $arr_data;
		}
	}

	/* 调用API addReply  添加回复接口*/
	public function addReply() {
		$this->init();
		$command = "addReply"; // 请求命令
		$userId = $this->userID; // 用户ID
		$companyId = $this->companyId; // 企业ID
		$replyContent = $this->in_arr ["replyContent"]; // 回复内容
		$commentId = $this->in_arr ["commentId"]; // 评论ID
		$mesId = $this->in_arr ["mesId"]; // 消息ID
		$replyToUserId = $this->in_arr ["replyToUserId"]; // 被回复人ID

		$data = array (
				"command" 	  	=> $command,
				"userId" 	  	=> $userId,
				"companyId"	  	=> $companyId,
				"replyContent"  => $replyContent,
				"commentId"	  	=> $commentId,
				"mesId"	  		=> $mesId,
				"replyToUserId" => $replyToUserId,
		);

		$url = C ( "OperatehttpUrl" ) . $url;

		$json_data = postData ( $url, $data );

		if (IS_AJAX) {
			echo $json_data;
		} else {
			$arr_data = json_decode($json_data, true);
			return $arr_data;
		}
	}

	/* 判断API返回值 */
	private function checkApiResult($apiName, $apiReturnValue) {
		$json_Array = json_decode ( $this->dejson($apiReturnValue ), true );
		$ErrorValue = "";
		if ($json_Array ['conf_auth'] == "F") {
			$ErrorValue = "COMMAND不存在。";
		}
		if ($json_Array ['error_code'] != "success") {
			$ErrorValue = $json_Array ['error_text'];
		}
		$this->assign ( $apiName . '_ErrorMsg', $ErrorValue );
		return $json_Array;
	}
	
	/* 初始化发送人选择画面 */
	public function selectUsers() {
		$this->init();
		$dept_list = $this->formatDeptList(true);
		$this->assign ( "dept_list", $dept_list);
		$this->assign ( "userNames", I ( "get.userNames" ) );
		$this->assign ( "userIds", I ( "get.userIds" ) );
		$this->display ();
	}

	/* 初始化发送人选择画面 */
	public function selectMessageUsers() {
		$this->init();
		$dept_list = $this->formatDeptList(true);
		$this->assign ( "dept_list", $dept_list);
		$this->assign ( "userNames", I ( "get.userNames" ) );
		$this->assign ( "userIds", I ( "get.userIds" ) );
		$this->display ();
	}

	/* 初始化发送人选择画面 */
	public function selectUser() {
		$this->init();
		$dept_list = $this->formatDeptList(true);
		$userDetail = $this->viewUserDetail(I ( "get.userId" ));
		$info = json_decode($userDetail, true);
		$this->assign ( "dept_list", $dept_list);
		$this->assign ( "userId", I ( "get.userId" ));
		$this->assign ( "userName", $info['name']);
		$this->assign ( "photoId", $info['photoId']);
		$this->assign ( "no", I ( "get.no" ) );
		$this->assign ( "objId", I ( "get.objId" ) );
		$this->assign ( "selected", I ( "get.selected" ) );
		$this->display ();
	}

	/* 初始化报销转批人选择画面 */
	public function selectApplyUser() {
		$this->init();
		$dept_list = $this->formatDeptList(true);
		$this->assign ( "dept_list", $dept_list);
		$this->assign ( "processId", I ( "get.processId" ));
		$this->assign ( "processNodeId", I ( "get.processNodeId" ) );
		$this->assign ( "comment", I ( "get.comment" ) );
		$this->assign ( "operateType", I ( "get.operateType" ) );
		$this->assign ( "page", I ( "get.page" ) );
		$this->assign ( "busiType", I ( "get.busiType" ) );
		$this->display ();
	}

	/* 初始化请假转批人选择画面 */
	public function selectLeaveUser() {
		$this->init();
		$dept_list = $this->formatDeptList(true);
		$this->assign ( "dept_list", $dept_list);
		$this->assign ( "processId", I ( "get.processId" ));
		$this->assign ( "processNodeId", I ( "get.processNodeId" ) );
		$this->assign ( "comment", I ( "get.comment" ) );
		$this->assign ( "operateType", I ( "get.operateType" ) );
		$this->assign ( "page", I ( "get.page" ) );
		$this->assign ( "busiType", I ( "get.busiType" ) );
		$this->display ();
	}

	/* 初始化出差转批人选择画面 */
	public function selectTravelUser() {
		$this->init();
		$dept_list = $this->formatDeptList(true);
		$this->assign ( "dept_list", $dept_list);
		$this->assign ( "processId", I ( "get.processId" ));
		$this->assign ( "processNodeId", I ( "get.processNodeId" ) );
		$this->assign ( "comment", I ( "get.comment" ) );
		$this->assign ( "operateType", I ( "get.operateType" ) );
		$this->assign ( "page", I ( "get.page" ) );
		$this->assign ( "busiType", I ( "get.busiType" ) );
		$this->display ();
	}

	/* 初始化费用转批人选择画面 */
	public function selectFeeUser() {
		$this->init();
		$dept_list = $this->formatDeptList(true);
		$this->assign ( "dept_list", $dept_list);
		$this->assign ( "processId", I ( "get.processId" ));
		$this->assign ( "processNodeId", I ( "get.processNodeId" ) );
		$this->assign ( "comment", I ( "get.comment" ) );
		$this->assign ( "operateType", I ( "get.operateType" ) );
		$this->assign ( "page", I ( "get.page" ) );
		$this->assign ( "busiType", I ( "get.busiType" ) );
		$this->display ();
	}

	/* 初始化发送人选择画面 */
	public function selectDepts() {
		$this->init();
		$dept_list = $this->formatDeptList(false);
		$this->assign ( "dept_list", $dept_list);
		$this->assign ( "deptNames", I ( "get.deptNames" ) );
		$this->assign ( "deptIds", I ( "get.deptIds" ) );
		$this->display ();
	}

	public function selectDicts() {
		$this->init();
		$dict_list = $this->formatDictList();
		$this->assign ( "dict_list", $dict_list);
		$this->assign ( "dictNames", I ( "get.dictNames" ) );
		$this->assign ( "dictIds", I ( "get.dictIds" ) );
		$this->display ();
	}
	
	public function selectAreas() {
		$this->init();
		$area_list = $this->formatAreaList();
		$this->assign ( "area_list", $area_list);
		$this->assign ( "areaNames", I ( "get.areaNames" ) );
		$this->assign ( "areaIds", I ( "get.areaIds" ) );
		$this->display ();
	}
	
	private function formatDeptList($hrefFlag = false) {
		$json_DeptListData = $this->getAllDeptList ();
		$json_Array = json_decode ( $this->dejson($json_DeptListData ) , true );
		$dept_list = array();
		foreach ($json_Array['list'] as $k => $v) {
			if ($v['deptLevel'] == '1') {
				$dept_list[0]['deptId'] = $v['deptId'];
				$dept_list[0]['text'] = $v['deptName'];
				if ($hrefFlag) {
					$dept_list[0]['href'] = 'javascript:getUserListByDeptId(' . $v['deptId'] . ')';
				}
				$dept_list[0]['children'] = array();
			} else {
				$keys = $this->findDeptKey($dept_list, $v['deptParent'], intval($v['deptLevel']));
				$arr = array(
					'deptId' => $v['deptId'],
					'text' => $v['deptName'], 
					'children' => array());
				if ($hrefFlag) {
					$arr['href'] = 'javascript:getUserListByDeptId(' . $v['deptId'] . ')';
				}
				if (array_key_exists('k4', $keys)) {
					$dept_list[$keys['k1']]['children'][$keys['k2']]['children'][$keys['k3']]['children'][$keys['k4']]['children'][] = $arr;
				} else if (array_key_exists('k3', $keys)) {
					$dept_list[$keys['k1']]['children'][$keys['k2']]['children'][$keys['k3']]['children'][] = $arr;
				} else if (array_key_exists('k2', $keys)) {
					$dept_list[$keys['k1']]['children'][$keys['k2']]['children'][] = $arr;
				} else if (array_key_exists('k1', $keys)) {
					$dept_list[$keys['k1']]['children'][] = $arr;
				}
			}
		}

		return json_encode($dept_list);
	}
	
	private function formatDictList() {
		$json_DictListData = $this->getDictByCondition ();
		$json_Array = json_decode ( $this->dejson($json_DictListData ) , true );
		$dict_list = array();
		foreach ($json_Array['list'] as $k => $v) {
			if ($v['dictGrade'] == '1') {
				$dict_list[$k]['dictId'] = $v['dictId'];
				$dict_list[$k]['text'] = $v['dictName'];
				$dict_list[$k]['parentId'] = $v['parentId'];
				$dict_list[$k]['children'] = array();
			} else {
				foreach ($dict_list as $k1 => $v1){
					if($v['parentId'] == $dict_list[$k1]['dictId']){
						$arr = array(
								'dictId' => $v['dictId'],
								'text' => $v['dictName'],
								'paretnId' => $v['parentId'],
								'children' => array());
						$dict_list[$k1]['children'][] = $arr;
					}
				}
			}
				
		}
		return json_encode($dict_list);
	}
	
	private function formatAreaList() {
		$json_AreaListData = $this->getAreaList ();
		$json_Array = json_decode ( $this->dejson($json_AreaListData ) , true );
		$area_list = array();
		foreach ($json_Array['areaList'] as $k => $v) {
			if ($v['areaLevelNo'] == '1') {
				$area_list[$k]['areaId'] = $v['areaId'];
				$area_list[$k]['text'] = $v['areaName'];
				$area_list[$k]['parentAreaId'] = $v['parentAreaId'];
				$area_list[$k]['areaLevelNo'] = $v['areaLevelNo'];
				$area_list[$k]['children'] = array();
			} else {
				$keys = $this->findAreaKey($area_list, $v['parentAreaId'], intval($v['areaLevelNo']));
				$arr = array(
						'areaId' => $v['areaId'],
						'text' => $v['areaName'],
						'children' => array());
				if (array_key_exists('k5', $keys)) {
					$area_list[$keys['k1']]['children'][$keys['k2']]['children'][$keys['k3']]['children'][$keys['k4']]['children'][$keys['k5']]['children'][] = $arr;
				} else if (array_key_exists('k4', $keys)) {
					$area_list[$keys['k1']]['children'][$keys['k2']]['children'][$keys['k3']]['children'][$keys['k4']]['children'][] = $arr;
				} else if (array_key_exists('k3', $keys)) {
					$area_list[$keys['k1']]['children'][$keys['k2']]['children'][$keys['k3']]['children'][] = $arr;
				} else if (array_key_exists('k2', $keys)) {
					$area_list[$keys['k1']]['children'][$keys['k2']]['children'][] = $arr;
				} else if (array_key_exists('k1', $keys)) {
					$area_list[$keys['k1']]['children'][] = $arr;
				}
			}
		}
		return json_encode($area_list);
	}
	/**
	 * 校验日期格式是否正确
	 *
	 * @param string $date 日期
	 * @param string $formats 需要检验的格式数组
	 * @return boolean
	 */
	function checkDateIsValid($date, $formats = array("Y-m-d", "Y/m/d")) {
		$unixTime = strtotime($date);
		if (!$unixTime) { //strtotime转换不对，日期格式显然不对。
			return false;
		}
		//校验日期的有效性，只要满足其中一个格式就OK
		foreach ($formats as $format) {
			if (date($format, $unixTime) == $date) {
				return true;
			}
		}
	
		return false;
	}
	
	private function findDeptKey($dept_list, $dept_id, $level=2) {
		if (!$level) {
			$level = 4;
		}
		$keys = array();
		foreach ($dept_list as $k1 => $v1) {
			$keys['k1'] = $k1;
			if ($v1['deptId'] == $dept_id) {
				return $keys;
			}
			if ($level > 1) {
				foreach ($v1['children'] as $k2 => $v2) {
					$keys['k2'] = $k2;
					if ($v2['deptId'] == $dept_id) {
						return $keys;
					} else if ($level > 2) {
						foreach ($v2['children'] as $k3 => $v3) {
							$keys['k3'] = $k3;
							if ($v3['deptId'] == $dept_id) {
								return $keys;
							} else if ($level > 3) {
								foreach ($v3['children'] as $k4 => $v4) {
									$keys['k4'] = $k4;
									if ($v4['deptId'] == $dept_id) {
										return $keys;
									}
								}
							}
						}
					}
				}
			}
		}
		return $keys;
	}
	
	private function findAreaKey($area_list, $area_id, $level) {
		if (!$level) {
			$level = 5;
		}
		$keys = array();
		foreach ($area_list as $k1 => $v1) {
			$keys['k1'] = $k1;
			if ($v1['areaId'] == $area_id) {
				return $keys;
			}
			if ($level > 1) {
				foreach ($v1['children'] as $k2 => $v2) {
					$keys['k2'] = $k2;
					if ($v2['areaId'] == $area_id) {
						return $keys;
					} else if ($level > 2) {
						foreach ($v2['children'] as $k3 => $v3) {
							$keys['k3'] = $k3;
							if ($v3['areaId'] == $area_id) {
								return $keys;
							} else if ($level > 3) {
								foreach ($v3['children'] as $k4 => $v4) {
									$keys['k4'] = $k4;
									if ($v4['areaId'] == $area_id) {
										return $keys;
									} else if ($level > 4) {
										foreach ($v4['children'] as $k5 => $v5){
											$keys['k5'] = $k5;
											if ($v5['areaId'] == $area_id) {
												return $keys;
											}
										}
									}
								}
							}
						}
					}
				}
			}
		}
		return $keys;
	}

	private function getPages($total=0) {
        $totalPage = ceil($total / $this->pageSize);	//总页数
        return array(
        		'total' => $total,
        		'pageSize' => $this->pageSize,
        		'totalPage' => $totalPage);
	}
	
	private function dejson($str){
		//$str = str_replace("\\", '\\\\', $str);
		//$str = str_replace("\r\n", "", $str);
		//$str = str_replace("\n", "", $str);
	    $str = str_replace("\n", ' ', 	$str);
		return $str;
	}

	/* 10.2 获取附件记录列表接口 getAttachList */
	private function getAttachList($tblname = 'bbsMessage') {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "getAttachList",
				"tblname" => $tblname,
				"linkid" => $this->in_arr ["messageId"]
		);
		$json_data = postData ( $url, $data );
		return $json_data;
	}

	/* 10.2 获取附件记录列表接口 getAttachList */
	private function getAttachListReport() {
		$url = C ( "OperatehttpUrl" ) . $url;
		$data = array (
				"command" => "getAttachList",
				"tblname" => "workReport",
				"linkid" => $this->in_arr ["reportID"]
		);
		$json_data = postData ( $url, $data );
		$arr_data = json_decode($json_data, true);
		return $arr_data;
	}

	// 下载附件
	public function downloadFile() {
		$this->init();
		$data = array();

		$file_name = $this->in_arr ["path"];
		$file_dir = "./Public/upfile/";
		if (!file_exists($file_dir . $file_name)) { //检查文件是否存在
			echo "文件找不到";
			exit;
		} else {
			$file = fopen($file_dir . $file_name,"r"); // 打开文件
			// 输入文件标签
			Header("Content-type: application/octet-stream");
			Header("Accept-Ranges: bytes");
			Header("Accept-Length: ".filesize($file_dir . $file_name));
			Header("Content-Disposition: attachment; filename=" . $file_name);
			// 输出文件内容
			echo fread($file,filesize($file_dir . $file_name));
			fclose($file);
			exit;
		}
	}

	// 下载附件
	public function downloadAttachFile() {

		$this->init();
		$data = array();

		$fileUrl = $this->in_arr ["fileUrl"];

		if(strstr($fileUrl, "file=")) {
			$fileUrl = str_replace("file=", "", $fileUrl);
			$file_name = base64_decode($fileUrl);
			
			$file_dir = "./Public/upfile/";
			if (!file_exists($file_dir . $file_name)) { //检查文件是否存在
				echo "文件找不到";
				exit;
			} else {
				$file = fopen($file_dir . $file_name,"r"); // 打开文件
				// 输入文件标签
				Header("Content-type: application/octet-stream");
				Header("Accept-Ranges: bytes");
				Header("Accept-Length: ".filesize($file_dir . $file_name));
				Header("Content-Disposition: attachment; filename=" . $file_name);
				// 输出文件内容
				echo fread($file,filesize($file_dir . $file_name));
				fclose($file);
				exit;
			}
		} else {
			echo "文件路径错误";
			exit;
		}
	}
}
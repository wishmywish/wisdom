<?php
namespace Api\Controller;
use Think\Crypt\Driver\Think;

use Think\Controller;

class WebController extends Controller {
    
    private  $in_arr,$out_arr;
    
    private function getConf()
    {
        $this->in_arr = array_merge($_GET,$_POST);
    }
    
    private function pushConf(){
        echo A('Api/Fun')->JSON($this->out_arr);
        //A("Fun")->JSON();
        //echo json_encode($this->out_arr);
    }

    public function getToalPage() {
        $this->getConf();//取数据
        
        $tasktypeid = $this->in_arr['tasktypeid'];
        $companyid = $this->in_arr['companyid'];
        
        //$page = $this->in_arr['page'];
        $in_Id = A('Fun')->getTaskTypeId($tasktypeid);
        //$t = M('task');
        if($tasktypeid!=0){
            $map['f_tasktypeid'] = array('in',$in_Id);
         }
         if($companyid!=0){
            $map['f_companyid'] = $companyid;
         }
//         if($page==0 || $page==""){
//            $page = 1;
//         }
         //$map['f_status']  = array('neq',0);
         
        //echo $in_Id;
        //$START_RECORD = $this->in_arr['START_RECORD'];
        $total = D('Task')->getTaskNo($in_Id,$companyid);//总记录数
        //$total = $obj->count();//总记录数
        $pageSize = 18; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
//        $this->out_arr['page'] = $page;
//        $this->out_arr['total'] = $total;
//        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;
        
        $this->pushConf();//输出数据
    }


    //WEB端调用任务列表
//    $rejava = json_decode(A('Jhttp')->getCompanyInfo($companyid),true);
//        if($rejava['resCode']=='000000'){
//            $companyName = "";
//        }else{
//            $companyName = "";
//        }
   public function getproList() {
       $this->getConf();//取数据
        
        $tasktypeid = $this->in_arr['tasktypeid'];
        $companyid = $this->in_arr['companyid'];
        //cho $tasktypeid;
        
        $page = $this->in_arr['page'];
        //echo $page;
        $in_Id = A('Fun')->getTaskTypeId($tasktypeid);
        $t = M('task');
        if($tasktypeid!=0){
            $map['f_tasktypeid'] = array('in',$in_Id);
         }else {
           $map['f_tasktypeid']=array('in','1,2,4,5,6');
         }
         if($companyid!=0){
            $map['f_companyid'] = $companyid;
         }
         if($page==0 || $page==""){
            $page = 1;
         }
         $map['f_status']  = array('neq',0);
        if($tasktypeid==1){
            $f = "f_tid,f_surveno,f_title,f_enddate,f_status,f_creatdate,f_eachcoin,f_totalcopies,f_tasktypeid";
            $j = array("LEFT JOIN t_tasksmallinfo ON t_tasksmallinfo.f_taskid = t_task.f_tid");
            
        }elseif($tasktypeid==2 || $tasktypeid==4 || $tasktypeid==5 || $tasktypeid==6){
           $f = "f_tid,f_surveno,f_title,f_enddate,f_status,f_creatdate,f_eachcoin,f_totalcopies,f_tasktypeid";
            $j = array("LEFT JOIN t_tasksmallinfo ON t_tasksmallinfo.f_taskid = t_task.f_tid");
        }else{
            $f = "f_tid,f_surveno,f_title,f_enddate,f_status,f_creatdate,f_eachcoin,f_totalcopies,f_tasktypeid";
            $j = array("LEFT JOIN t_tasksmallinfo ON t_tasksmallinfo.f_taskid = t_task.f_tid");
        }
        $total = $t->field($f)->where($map)->join($j)->count();//总记录数
        //echo $total;
        //$total = $obj->count();//总记录数
        $pageSize = 10; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;
        $list = $t->field($f)->where($map)->page($page.','.$pageSize)->join($j)->order('f_creatdate desc')->select();
        //echo $t->getLastSql();
        foreach ($list as $key => $val) {
            $list[$key]['f_eachcoin_plat'] = $val['f_eachcoin'];
            $list[$key]['f_plattotal'] = $val['f_eachcoin']*2*$val['f_totalcopies'];
            $taskid=$val['f_tid'];
            $map['f_taskid']=$taskid;
            $map['f_shopingtype']=1;
            $map['f_amount']=array("neq",0);
            $map['f_label']='task';
            $num=M('shopsheet')->where($map)->count();
            if($num > $val['f_totalcopies']){
                $val['f_status']=4;
                $t->where('f_tid='.$taskid)->setField("f_status",4);
            }
        }
        $this->out_arr['list']=$list;
        //echo $t->getLastsql();
        $this->pushConf();//输出数据
   }
    
    public function getTaskList() {
        $this->getConf();//取数据
        
        $tasktypeid = $this->in_arr['tasktypeid'];
        $companyid = $this->in_arr['companyid'];
        
        $page = $this->in_arr['page'];
        $in_Id = A('Fun')->getTaskTypeId($tasktypeid);
        $t = M('task');
        if($tasktypeid!=0){
            $map['f_tasktypeid'] = array('in',$in_Id);
         }
         if($companyid!=0){
            $map['f_companyid'] = $companyid;
         }
         if($page==0 || $page==""){
            $page = 1;
         }
         $map['f_status']  = array('neq',0);
         
        //echo $in_Id;
        //$START_RECORD = $this->in_arr['START_RECORD'];
        $total = D('Task')->getTaskNo($in_Id,$companyid);//总记录数
        //$total = $obj->count();//总记录数
        $pageSize = 18; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;
        
        if($tasktypeid==1){
            $f = "";
            $j = array("LEFT JOIN t_tasktype ON t_tasktype.f_typeid = t_task.f_tasktypeid");
        }elseif($tasktypeid==2 || $tasktypeid==4 || $tasktypeid==5 || $tasktypeid==6){
            $f = "";
            $j = array("LEFT JOIN t_tasktype ON t_tasktype.f_typeid = t_task.f_tasktypeid");
        }elseif($tasktypeid==3){
            //{"f_tid":"35","f_companyid":"103","f_creatuserid"
            $time=date("Y-m-d",time());
            $data['f_enddate']=array('LT',$time);
            $data['f_companyid']=$companyid;
            $data['f_tasktypeid']=$tasktypeid;
            $re=$t->where($data)->setField('f_status',4);
            $f = "f_tasktypeid,f_tid,f_surveno,f_title,f_creatdate,f_companyid,f_creatuserid,f_description,f_begindate,f_enddate,f_status,f_typename,f_linkman,f_linkphone,f_mtbrand,f_mtgoods,f_unitfirstAmount,f_unitcashdeposit,f_unitfranchisefee,f_unitotheramount,f_unittotalamount,f_tradename";
            $j = array("LEFT JOIN t_taskmtbaseinfo ON t_taskmtbaseinfo.f_taskid = t_task.f_tid","LEFT JOIN t_taskmtdetailedinfo ON t_taskmtdetailedinfo.f_taskid = t_task.f_tid","LEFT JOIN t_taskmtattach ON t_taskmtattach.f_taskid = t_task.f_tid","LEFT JOIN t_tasktype ON t_tasktype.f_typeid = t_task.f_tasktypeid","LEFT JOIN t_tradetype ON t_tradetype.f_tradeID = t_taskmtbaseinfo.f_tradeid");
        }else{
            $f = "";
            $j = array("LEFT JOIN t_tasktype ON t_tasktype.f_typeid = t_task.f_tasktypeid");
        }

        $this->out_arr['list'] = $t->field($f)->where($map)->page($page.','.$pageSize)->join($j)->order('f_creatdate desc')->select();
        //$this->out_arr['sql'] = $t->getLastsql();
        // var_dump($this->pushConf());
        $this->pushConf();//输出数据
    }
    
    public function getPublishTask() {
        $this->getConf();//取数据
        
        $page = $this->in_arr['page'];

        if($page==0 || $page==""){
          $page = 1;
        }

        $t = M('task');
        $map['f_status']  = array('eq',3);
        $map['f_tasktypeid']  = array('eq',3);

        $total = D('Task')->getPublishTaskNo();//总记录数
        $pageSize = 10; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;

        $this->out_arr['list'] = $t->where($map)->page($page.','.$pageSize)->order('f_creatdate desc')->select();

        $this->pushConf();//输出数据
    }

    public function getActivity() {
        $this->getConf();//取数据
        
        $tabType = isset($this->in_arr['tabType'])?$this->in_arr['tabType']:1;
        $page = $this->in_arr['page'];

        if($page==0 || $page==""){
          $page = 1;
        }

        $t = M('ad');
        $map['f_type']  = $tabType;

        $total = $t->where($map)->count();//总记录数
        $pageSize = 10; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;

        $f = "t_ad.f_id,f_title,f_datetime,f_starttime,f_endtime,f_url,f_type,f_fid,f_top,f_desc,f_filename,f_filepath";
        $j = array("LEFT JOIN t_files ON t_files.f_id = t_ad.f_fid");
        $this->out_arr['list'] = $t->field($f)->where($map)->page($page.','.$pageSize)->join($j)->order('t_ad.f_id desc')->select();
//        foreach ($this->out_arr['list'] as $key => $value) {
//            $this->out_arr['list'][$key]['f_name'] = M("files")->where("f_id=".$value['f_fid'])->find();
//        }
// var_dump($this->out_arr['list']);exit();
        $this->pushConf();//输出数据
    }

    public function getActivityPage() {
        $this->getConf();//取数据

        $tabType = isset($this->in_arr['tabType'])?$this->in_arr['tabType']:1;
        $t = M('ad');
        $map['f_type']  = $tabType;

        $total = $t->where($map)->count();//总记录数

        $pageSize = 10; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数

        $this->out_arr['totalPage'] = $totalPage;
        
        $this->pushConf();//输出数据
    }

    public function addActivity() {
        $this->getConf();//取数据

        $t = M('ad');
        $map['f_type']  = $this->in_arr['type'];
        $map['f_title']  = $this->in_arr['title'];
        $map['f_starttime']  = strtotime($this->in_arr['startdate']);
        $map['f_endtime']  = strtotime($this->in_arr['enddate']);
        $map['f_url']  = $this->in_arr['shareUrl'];
        $map['f_top']  = $this->in_arr['isShow'];
        $map['f_note']  = $this->in_arr['content'];
        $map['f_fid']  = $this->in_arr['fileid'];
        $map['f_desc']  = $this->in_arr['adDescription'];
        $map['f_datetime']  = time();

        $t->data($map)->add();//总记录数
        
        $this->pushConf();//输出数据
    }

    public function delActivity() {
        $this->getConf();//取数据
        
        $map['f_status'] = 0;
        $activityIds = explode("|", $this->in_arr['activityIds']);
        //echo count($taskids);
        for($i=0;$i<count($activityIds);$i++){
            M('ad')->where('f_id='.$activityIds[$i])->delete();
            //echo M('task')->getLastsql();
        }
        $this->out_arr['result'] = '000000';
        
        $this->pushConf();//输出数据
    }
    
    public function getModiAd() {
        $this->getConf();//取数据
        
        $activityId = isset($this->in_arr['activityId'])?$this->in_arr['activityId']:0;
        if($activityId==0){
            $this->out_arr['result'] = '100000';
        }else{
            $this->out_arr['list'] = M('ad')->where('f_id='.$activityId)->find();

            $this->out_arr['list']['f_starttime'] = date("Y/m/d", $this->out_arr['list']['f_starttime']) ;
            $this->out_arr['list']['f_endtime'] = date("Y/m/d", $this->out_arr['list']['f_endtime']) ;
            $this->out_arr['list']['f_note'] = str_replace(PHP_EOL, '', $this->out_arr['list']['f_note']); 

            $this->out_arr['list']['f_name'] = M("files")->where("f_id=".$this->out_arr['list']['f_fid'])->find();

            $this->out_arr['result'] = '000000';
        }
        
        return $this->out_arr;
    }

    public function upActivity() {
        $this->getConf();//取数据
        
        $t = M('ad');
        $map['f_type']  = $this->in_arr['type'];
        $map['f_title']  = $this->in_arr['title'];
        $map['f_starttime']  = strtotime($this->in_arr['startdate']);
        $map['f_endtime']  = strtotime($this->in_arr['enddate']);
        $map['f_url']  = $this->in_arr['shareUrl'];
        $map['f_top']  = $this->in_arr['isShow'];
        $map['f_note']  = $this->in_arr['content'];
        $map['f_fid']  = $this->in_arr['fileid'];
        $map['f_desc']  = $this->in_arr['adDescription'];
        $map['f_datetime']  = time();

        $t->where('f_id='.$this->in_arr['activityId'])->save($map);//总记录数
        
        $this->pushConf();//输出数据
    }

    public function getCompanyInfo() {
        $this->getConf();//取数据
        
        $dealerId = isset($this->in_arr['dealerId'])?$this->in_arr['dealerId']:0;
        if($dealerId==0){
            $this->out_arr['result'] = '100000';
        }else{
            $this->out_arr['one'] = M('taskmtbaseinfo')->field("f_mtbrand,f_mtgoods,f_unitfirstAmount,f_unitcashdeposit,f_unitfranchisefee,f_unitotheramount,f_unittotalamount,f_unitcommission,f_tradeid")->where('f_taskid='.$dealerId)->find();
            $this->out_arr['two']= M('task')->field("f_begindate,f_enddate,f_linkman,f_linkphone,f_companyid,f_title")->where('f_tid='.$dealerId)->find();
            $companyDetail = A('Api/Jhttp')->getCompanyInfo($this->out_arr['two']['f_companyid']);
            $arr=json_decode($companyDetail,true);
            $this->out_arr['companyName'] = $arr['list']['companyName'];
            if (isset($this->out_arr['one'])) {
              $this->out_arr['trade'] = M('tradetype')->field("f_tradename")->where('f_tradeID='.$this->out_arr['one']['f_tradeid'])->find();
            }else{
              $this->out_arr['trade'] = '';
            }

            $this->out_arr['three'] = M('taskmtdetailedinfo')->field("f_brandlocation,f_distributorsrequir")->where('f_taskid='.$dealerId)->find();
            $this->out_arr['four'] = M('taskmtareaqty')->field("f_area,f_qty")->where('f_taskid='.$dealerId)->select();

            $this->out_arr['result'] = '000000';
        }
        
        return $this->out_arr;
    }

    public function getDetail() {
        $this->getConf();//取数据
        
        $dealerId = isset($this->in_arr['dealerid'])?$this->in_arr['dealerid']:0;
        if($dealerId==0){
            $this->out_arr['result'] = '100000';
        }else{
            $this->out_arr['one'] = M('dealerbaseinfo')->field("f_companynameone,f_userid")->where('f_dealerid='.$dealerId)->find();
            $this->out_arr['two']= M('dealerqualifyinfo')->where('f_dealerid='.$dealerId)->find();

            $userDetails = A('Api/Jhttp')->getUserinfo2($this->out_arr['one']['f_userid']);
            $arr=json_decode($userDetails,true);
            $this->out_arr['one']['trueName'] = $arr['list']['trueName']; 
            $this->out_arr['one']['mobile'] = $arr['list']['mobile']; 

            $this->out_arr['result'] = '000000';
        }
        
        return $this->out_arr;
    }

    public function showManDetail() {
        $this->getConf();//取数据
        
        $userid = isset($this->in_arr['userid'])?$this->in_arr['userid']:0;
        if($userid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $f['f_userid']=$userid;
            $f['f_status']=0;
            $this->out_arr['one'] = M('useraccount')->where($f)->select();
            foreach ($this->out_arr['one'] as $key => $value) {
                $this->out_arr['one'][$key]['f_linkdatetime'] = date("Y-m-d H:i:s",$value['f_linkdatetime']);
            }
            // var_dump($this->out_arr['one']);exit();

            $userDetails = A('Api/Jhttp')->getUserinfo2($userid);
            $arr=json_decode($userDetails,true);
            $this->out_arr['list']= $arr['list']; 

            $this->out_arr['result'] = '000000';
        }
        
        return $this->out_arr;
    }

    public function showCompanyDetail() {
        $this->getConf();//取数据
        
        $companyId = isset($this->in_arr['companyId'])?$this->in_arr['companyId']:0;
        if($companyId==0){
            $this->out_arr['result'] = '100000';
        }else{
            $userDetails = A('Api/Jhttp')->getCompanyInfo($companyId);
            $arr=json_decode($userDetails,true);
            $this->out_arr['list']= $arr['list']; 
            if (!empty($this->out_arr['list']['companyExtList'])) {
                foreach ($this->out_arr['list']['companyExtList'] as $key => $value) {
                    if (isset($value['extValue'])) {
                        $this->out_arr['list']['companyExtList'][$key]['f_name'] = M("files")->where("f_id=".$value['extValue'])->find();
                    }
                }
            }
            $this->out_arr['result'] = '000000';
        }
        
        return $this->out_arr;
    }

    public function checkCompany() {
        $this->getConf();//取数据
        
        $companyId = isset($this->in_arr['companyId'])?$this->in_arr['companyId']:0;
        $state = isset($this->in_arr['state'])?$this->in_arr['state']:1;

        if($companyId==0){
            $this->out_arr['result'] = '100000';
        }else{
            $result = A('Api/Jhttp')->checkCompany($companyId,$state);

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    public function showdtask() {
        $this->getConf();//取数据

        $userid = isset($this->in_arr['userid'])?$this->in_arr['userid']:0;
        if($userid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $taskids = M('taskdraw')->field('distinct(f_taskid)')->where('f_userid='.$userid)->select();
            foreach ($taskids as $key => $value) {
                $tasks[] = M('task')->where('f_tid='.$value['f_taskid'])->find();
            }

            foreach ($tasks as $key => $value) {
                if (isset($value['f_tasktypeid'])) {
                    $tasks[$key]['f_tasktype'] = M('tasktype')->field('F_TYPENAME')->where('F_TYPEID='.$value['f_tasktypeid'])->find();
                }
            }
            $tasks['result'] = '000000';
            $tasks['userid'] = $userid;
        }
        return $tasks;

    }


    public function taskType($userid,$taskType) {

        if($userid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $f['f_userid'] = $userid;
            $f['f_utask_status'] = $taskType;
            if ($taskType == 0) {
                $taskids = M('taskdraw')->field('distinct(f_taskid)')->where('f_userid='.$userid)->select();
            }else{
                $taskids = M('taskdraw')->field('distinct(f_taskid)')->where($f)->select();
            }
            foreach ($taskids as $key => $value) {
                $tasks = M('task')->where('f_tid='.$value['f_taskid'])->find();
                if ($tasks) {
                    $this->out_arr['list'][]=$tasks;
                }
            }

            foreach ($this->out_arr['list'] as $key => $value) {
                if (isset($value['f_tasktypeid'])) {
                    $this->out_arr['list'][$key]['f_tasktype'] = M('tasktype')->field('F_TYPENAME')->where('F_TYPEID='.$value['f_tasktypeid'])->find();
                }
            }
            $this->out_arr['result'] = '000000';
            $this->out_arr['userid'] = $userid;
            $this->out_arr['taskType'] = $taskType;
        }

        $this->pushConf();//输出数据
    }

    public function getPublishPage() {
        $this->getConf();//取数据

        $total = D('Task')->getPublishTaskNo();//总记录数

        $pageSize = 10; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数

        $this->out_arr['totalPage'] = $totalPage;
        
        $this->pushConf();//输出数据
    }

    public function delTask() {
        $this->getConf();//取数据
        
        $map['f_status'] = 0;
        $taskids = explode("|", $this->in_arr['taskids']);
        //echo count($taskids);
        for($i=0;$i<count($taskids);$i++){
            M('task')->where('f_tid='.$taskids[$i])->save($map);
            //echo M('task')->getLastsql();
        }
        $this->out_arr['result'] = '000000';
        
        $this->pushConf();//输出数据
    }

    //客服审核通过
    public function reviewTask() {
        $this->getConf();//取数据

        $taskid = isset($this->in_arr['taskid'])?$this->in_arr['taskid']:0;
        if($taskid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $t = M('taskreject');
            $map['f_reason']  = $this->in_arr['reason'];
            $map['f_taskid']  = $taskid;
            $map['f_rejectuserid']  = session("id");
            $map['f_proname']  = "review";
            $map['f_column']  = 100;
            $map['f_datetime']  = time();

            $t->data($map)->add();//总记录数

            $update['f_status'] = 7;
            
            M("task")->where('f_tid='.$taskid)->save($update); 
        
        }
        
        $this->pushConf();//输出数据
    }

    //客服审核不通过
    public function reviewTaskNo() {
        $this->getConf();//取数据

        $taskid = isset($this->in_arr['taskid'])?$this->in_arr['taskid']:0;
        if($taskid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $t = M('taskreject');
            $map['f_reason']  = $this->in_arr['reason'];
            $map['f_taskid']  = $taskid;
            $map['f_rejectuserid']  = session("id");
            $map['f_proname']  = "noReview";
            $map['f_column']  = 100;
            $map['f_datetime']  = time();

            $t->data($map)->add();//总记录数

            $update['f_status'] = 10;

            M("task")->where('f_tid='.$taskid)->save($update); 
        
        }
        
        $this->pushConf();//输出数据
    }

    //财务审核通过
    public function cwReviewTask() {
        $this->getConf();//取数据

        $taskid = isset($this->in_arr['taskid'])?$this->in_arr['taskid']:0;
        if($taskid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $t = M('taskreject');
            $map['f_reason']  = $this->in_arr['reason'];
            $map['f_taskid']  = $taskid;
            $map['f_rejectuserid']  = session("id");
            $map['f_proname']  = "cwReview";
            $map['f_column']  = 100;
            $map['f_datetime']  = time();

            $t->data($map)->add();//总记录数

            $update['f_status'] = 3;
            
            M("task")->where('f_tid='.$taskid)->save($update); 
        
        }
        
        $this->pushConf();//输出数据
    }

    //财务审核不通过
    public function cwReviewTaskNo() {
        $this->getConf();//取数据

        $taskid = isset($this->in_arr['taskid'])?$this->in_arr['taskid']:0;
        if($taskid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $t = M('taskreject');
            $map['f_reason']  = $this->in_arr['reason'];
            $map['f_taskid']  = $taskid;
            $map['f_rejectuserid']  = session("id");
            $map['f_proname']  = "noReview";
            $map['f_column']  = 100;
            $map['f_datetime']  = time();

            $t->data($map)->add();

            $update['f_status'] = 10;

            M("task")->where('f_tid='.$taskid)->save($update); 
        
        }
        
        $this->pushConf();//输出数据
    }

    //任务延时
    public function getDelayTask() {
        $this->getConf();//取数据

        $taskid = isset($this->in_arr['taskid'])?$this->in_arr['taskid']:0;
        if($taskid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $t = M('task');

            $this->out_arr['list'] = $t->where("f_tid=".$taskid)->find();
            $this->out_arr['result'] = '000000';
        
        }

        return $this->out_arr;
    }

   //任务更新确定
    public function getUpdateConfirm() {
        $this->getConf();//取数据

        $taskid = isset($this->in_arr['taskid'])?$this->in_arr['taskid']:0;

        if($taskid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $t = M('task');
            $map["f_creatdate"]=time();
            $this->out_arr['list'] = $t->where("f_tid=".$taskid)->save($map);

            $p = M('taskreject');
            $map['f_taskid']  = $taskid;
            $map['f_rejectuserid']  = session("id");
            $map['f_proname']  = "update";
            $map['f_column']  = 100;
            $map['f_datetime']  = time();
            $p->data($map)->add();

            $this->out_arr['result'] = '000000';
        
        }

        $this->pushConf();//输出数据
    }
     
    //任务延时确定
    public function getDelayConfirm() {
        $this->getConf();//取数据

        $taskid = isset($this->in_arr['taskid'])?$this->in_arr['taskid']:0;
        $newenddate = $this->in_arr['newenddate'];

        if($taskid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $t = M('task');
            $map["f_enddate"]=$newenddate;
            $this->out_arr['list'] = $t->where("f_tid=".$taskid)->save($map);

            $p = M('taskreject');
            $map['f_taskid']  = $taskid;
            $map['f_rejectuserid']  = session("id");
            $map['f_proname']  = "delay";
            $map['f_column']  = 100;
            $map['f_datetime']  = time();
            $p->data($map)->add();

            $this->out_arr['result'] = '000000';
        
        }

        $this->pushConf();//输出数据
    }

    public function getModiTask() {
        $this->getConf();//取数据
        
        $taskid = isset($this->in_arr['taskid'])?$this->in_arr['taskid']:0;
        $tasktypeid = isset($this->in_arr['tasktypeid'])?$this->in_arr['tasktypeid']:0;
        if($taskid==0 || $tasktypeid==0){
            $this->out_arr['result'] = '100000';
        }else{
            //$id = A("Api/Fun")->getTaskTypeId($tasktypeid);
            //$w['f_tasktypeid'] = array("in",$id);
            //$j = array("LEFT JOIN t_tasksmallinfo ON t_tasksmallinfo.f_taskid=t_task.f_tid");
            $this->out_arr['one'] = M('task')->where('f_tid='.$taskid)->find();

            $this->out_arr['one']['f_name'] = M("files")->where("f_id=".$this->out_arr['one']['f_fileid'])->find();
            if (isset($this->out_arr['one']['f_fileid_ban'])) 
            {
                $this->out_arr['one']['f_ban'] = M("files")->where("f_id=".$this->out_arr['one']['f_fileid_ban'])->find();
            }
            if (isset($this->out_arr['one']['f_companyid'])) {
                $result = A('Api/Jhttp')->getCompanyInfo($this->out_arr['one']['f_companyid']);
                $arr=json_decode($result,true);
                $this->out_arr['one']['companyName'] = $arr['list']['companyName']; 
            }
            //pt($this->out_arr['one']);
            //exit;
           
            if($tasktypeid==1){
               $this->out_arr['pro'] = M('tasksmallinfo')->where('f_taskid='.$taskid)->find();
               // $this->out_arr['pro']['f_taskrequirements'] = str_replace(PHP_EOL, '', $this->out_arr['pro']['f_taskrequirements']);
               $this->out_arr['pro']['f_taskrequirements'] = trim($this->out_arr['pro']['f_taskrequirements']);  
               $this->out_arr['pro']['f_taskrequirements'] = ereg_replace("\t","",$this->out_arr['pro']['f_taskrequirements']);  
               $this->out_arr['pro']['f_taskrequirements'] = ereg_replace("\r\n","",$this->out_arr['pro']['f_taskrequirements']);  
               $this->out_arr['pro']['f_taskrequirements'] = ereg_replace("\r","",$this->out_arr['pro']['f_taskrequirements']);  
               $this->out_arr['pro']['f_taskrequirements'] = ereg_replace("\n","",$this->out_arr['pro']['f_taskrequirements']);  

            }elseif($tasktypeid==4 || $tasktypeid==5 || $tasktypeid==6 || $tasktypeid==2){
                $this->out_arr['pro'] = M('tasksmallinfo')->where('f_taskid='.$taskid)->find();
                $this->out_arr['pro']['f_taskrequirements'] = trim($this->out_arr['pro']['f_taskrequirements']);  
                $this->out_arr['pro']['f_taskrequirements'] = ereg_replace("\t","",$this->out_arr['pro']['f_taskrequirements']);  
                $this->out_arr['pro']['f_taskrequirements'] = ereg_replace("\r\n","",$this->out_arr['pro']['f_taskrequirements']);  
                $this->out_arr['pro']['f_taskrequirements'] = ereg_replace("\r","",$this->out_arr['pro']['f_taskrequirements']);  
                $this->out_arr['pro']['f_taskrequirements'] = ereg_replace("\n","",$this->out_arr['pro']['f_taskrequirements']);

                $this->out_arr['detail'] = M('surveytaskdetail')->where('f_taskid='.$taskid)->select();
                foreach ( $this->out_arr['detail'] as $key => $value) {
                    $this->out_arr['detail'][$key]['answer']= explode('|', $value['f_options']);
                }
                $this->out_arr['detailCount']= count($this->out_arr['detail']);

            }elseif($tasktypeid==3){
                $this->out_arr['two'] = M('taskmtbaseinfo')->where('f_taskid='.$taskid)->find();
                $tradeid = $this->out_arr['two']['f_tradeid'];//取出行业ID
                //取大类ID
                $p = M('tradetype')->where('f_tradeID='.$tradeid)->find();
                $this->out_arr['two']['f_parentid'] = $p['f_parentid'];

                $this->out_arr['three']['area'] = M('taskmtareaqty')->where('f_taskid='.$taskid)->find();
                $this->out_arr['three']['pro'] = M('taskmtgoodsdetail')->where('f_taskid='.$taskid)->find();
                $this->out_arr['four'] = M('taskmtdetailedinfo')->where('f_taskid='.$taskid)->find();

                $this->out_arr['four']['f_note'] = trim($this->out_arr['four']['f_note']);  
                $this->out_arr['four']['f_note'] = ereg_replace("\t","",$this->out_arr['four']['f_note']);  
                $this->out_arr['four']['f_note'] = ereg_replace("\r\n","",$this->out_arr['four']['f_note']);  
                $this->out_arr['four']['f_note'] = ereg_replace("\r","",$this->out_arr['four']['f_note']);  
                $this->out_arr['four']['f_note'] = ereg_replace("\n","",$this->out_arr['four']['f_note']);
                // $this->out_arr['four']['f_note'] = ereg_replace(" ","",$this->out_arr['four']['f_note']);  
                // $four = $this->out_arr['four'];
                // $this->out_arr['four']['f_note'] = str_replace(PHP_EOL, '', $four['f_note']);
                // $this->out_arr['four']['f_note']= str_replace("\"",'\'',$this->out_arr['four']['f_note']);
                //pt($this->out_arr['four']);
                $this->out_arr['five'] = M('taskmtattach')->where('f_taskid='.$taskid)->find();
            }
            $this->out_arr['result'] = '000000';
        }
        
        //$this->pushConf();//输出数据
        return $this->out_arr;
    }

    public function getRejectTask() {
        $this->getConf();//取数据
        
        $taskid = isset($this->in_arr['taskid'])?$this->in_arr['taskid']:0;
        if($taskid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $t = M('taskreject');
            $map['f_reason']  = $this->in_arr['reason'];
            $map['f_taskid']  = $taskid;
            $map['f_rejectuserid']  = session("id");
            $map['f_proname']  = "reject";
            $map['f_column']  = 100;
            $map['f_datetime']  = time();

            $t->data($map)->add();//总记录数

            $update['f_status'] = '5';
            
            M("task")->where('f_tid='.$taskid)->save($update); 
        
        }
        $this->pushConf();//输出数据
    }

    //是否存在相应的授权书
    public function isTrue() {
        $this->getConf();//取数据
        $authorityNum = isset($this->in_arr['authorityNum'])?$this->in_arr['authorityNum']:0;

        if($authorityNum==0){
            $this->out_arr['result'] = '100000';
        }else{
            $this->out_arr['authorization'] = M("authorization")->where('f_authnumber='.$authorityNum)->find(); 
            $this->out_arr['result'] = '';
            $this->out_arr['userDetail'] = '';
            $this->out_arr['companyDetail'] = '';
            $this->out_arr['phone'] = '';
            if (isset($this->out_arr['authorization'])) {
                $j = array("LEFT JOIN t_task ON t_task.f_tid = t_dealerbaseinfo.f_taskid");
                $this->out_arr['detail'] = M('dealerbaseinfo')->JOIN($j)->where('f_dealerid='.$this->out_arr['authorization']['f_dealerid'])->find();

                $this->out_arr['userDetail'] = $this->getUserDetail($this->out_arr['detail']['f_userid']);
                $this->out_arr['companyDetail'] = $this->getCompanyDetail($this->out_arr['detail']['f_companyid']);

                $time = date("Y/m/d",$this->out_arr['authorization']['f_datetime']);
                $this->out_arr['date']= explode("/", $time);

            }
            $map['f_proname']='remit';
            $map['f_dealerid']=$this->out_arr['authorization']['f_dealerid'];
            $map['f_prostatus']=1;
            $top['f_proname']='receive';
            $top['f_dealerid']=$this->out_arr['authorization']['f_dealerid'];
            $top['f_prostatus']=1;
            $p['f_proname']='contract';
            $p['f_dealerid']=$this->out_arr['authorization']['f_dealerid'];
            $p['f_prostatus']=1;
            $c = array("LEFT JOIN t_files ON t_files.f_id = t_business_progress.f_fileid");

            $this->out_arr['remit'] = M('business_progress')->field('t_business_progress.*,t_files.f_filename,t_files.f_filepath,t_files.f_strat,t_files.f_uptime')->JOIN($c)->where($map)->find();
            $this->out_arr['receive'] = M('business_progress')->field('t_business_progress.*,t_files.f_filename,t_files.f_filepath,t_files.f_strat,t_files.f_uptime')->JOIN($c)->where($top)->find();
            $this->out_arr['contract'] = M('business_progress')->field('t_business_progress.*,t_files.f_filename,t_files.f_filepath,t_files.f_strat,t_files.f_uptime')->JOIN($c)->where($p)->find();

            if (isset($this->out_arr['authorization'])) {
                $this->out_arr['result']="000000";                 
            }else{
                $this->out_arr['result']="100000"; 
            }
        }
        $this->pushConf();
        // return $this->out_arr;
    }

    public function delDealerPic() {
        $this->getConf();//取数据
        
        $id = isset($this->in_arr['id'])?$this->in_arr['id']:0;
        if($id==0){
            $this->out_arr['result'] = '100000';
        }else{
            $map['f_prostatus']  = 0;
            $map['f_fileid']  = 0;
            $map['f_protime']  = time();
            
            M("business_progress")->where('f_id='.$id)->save($map); 

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    public function uploadContract() {
        $this->getConf();//取数据
        
        $dealerId = isset($this->in_arr['dealerId'])?$this->in_arr['dealerId']:0;
        $profile1 = isset($this->in_arr['profile1'])?$this->in_arr['profile1']:0;
        $contractId = isset($this->in_arr['contractId'])?$this->in_arr['contractId']:0;
        if($dealerId==0){
            $this->out_arr['result'] = '100000';
        }else{
            if ($contractId == 0) {
                $map['f_dealerid']  = $dealerId;
                $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
                $map['f_taskid']  = $result['f_taskid'];
                $map['f_proname']  = 'contract';
                $map['f_prostatus']  = 1;
                $map['f_fileid']  = $profile1;
                $map['f_protime']  = time();
                $this->out_arr['rid'] = M("business_progress")->add($map); 
            }else{
                $p['f_userid']  = session('id');
                $p['f_prostatus']  = 1;
                $p['f_fileid']  = $profile1;
                $p['f_protime']  = time();
                $isExist = M('business_progress')->where('f_id='.$contractId)->save($p);
                $this->out_arr['rid'] = $contractId;
            }

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    public function uploadRemit() {
        $this->getConf();//取数据
        
        $dealerId = isset($this->in_arr['dealerId'])?$this->in_arr['dealerId']:0;
        $profile1 = isset($this->in_arr['profile1'])?$this->in_arr['profile1']:0;
        $contractId = isset($this->in_arr['contractId'])?$this->in_arr['contractId']:0;
        if($dealerId==0){
            $this->out_arr['result'] = '100000';
        }else{
            $s['f_dealerid']  = $dealerId;
            $s['f_proname']  = 'remit';
            $s['f_prostatus']  = 0;
            $isExist = M('business_progress')->where($s)->find();

            // if (isset($isExist)) {
            //     $p['f_dealerid']  = $dealerId;
            //     $p['f_prostatus']  = 1;
            //     $p['f_fileid']  = $profile1;
            //     $p['f_protime']  = time();
            //     $re = M('business_progress')->where('f_id='.$isExist['f_id'])->save($p);
            // }else{
                $map['f_dealerid']  = $dealerId;
                $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
                $map['f_taskid']  = $result['f_taskid'];
                $map['f_proname']  = 'remit';
                $map['f_prostatus']  = 1;
                $map['f_fileid']  = $profile1;
                $map['f_protime']  = time();
                $this->out_arr['rid'] = M("business_progress")->add($map); 
            // }

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    public function uploadReceive() {
        $this->getConf();//取数据
        
        $dealerId = isset($this->in_arr['dealerId'])?$this->in_arr['dealerId']:0;
        $profile1 = isset($this->in_arr['profile1'])?$this->in_arr['profile1']:0;
        $contractId = isset($this->in_arr['contractId'])?$this->in_arr['contractId']:0;

        if($dealerId==0){
            $this->out_arr['result'] = '100000';
        }else{

            // $s['f_dealerid']  = $dealerId;
            // $s['f_proname']  = 'receive';
            // $s['f_prostatus']  = 0;
            // $isExist = M('business_progress')->where($s)->find();

            // if (isset($isExist)) {
            //     $p['f_dealerid']  = $dealerId;
            //     $p['f_userid']  = session('id');
            //     $p['f_prostatus']  = 1;
            //     $p['f_fileid']  = $profile1;
            //     $p['f_protime']  = time();
            //     $re = M('business_progress')->where('f_id='.$isExist['f_id'])->save($p);
            // }else{
                $map['f_dealerid']  = $dealerId;
                $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
                $map['f_taskid']  = $result['f_taskid'];
                $map['f_proname']  = 'receive';
                $map['f_prostatus']  = 1;
                $map['f_fileid']  = $profile1;
                $map['f_protime']  = time();
                $this->out_arr['rid'] = M("business_progress")->add($map); 
            // }

            $c['f_dealerid']  = $dealerId;
            $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
            $c['f_taskid']  = $result['f_taskid'];
            $c['f_proname']  = 'commissionsquare';
            $c['f_prostatus']  = 0;
            $c['f_protime']  = time();
            M("business_progress")->add($c); 

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }


    public function moneyCheck() {
        $this->getConf();//取数据
        
        $dealerId = isset($this->in_arr['dealerId'])?$this->in_arr['dealerId']:0;
        if($dealerId==0){
            $this->out_arr['result'] = '100000';
        }else{
            $map['f_dealerid']= $dealerId;
            $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
            $map['f_taskid']  = $result['f_taskid'];
            $map['f_userid']  = session('id');
            $map['f_proname']  = 'remit';
            $map['f_prostatus']  = 2;
            $map['f_protime']  = time();
            $this->out_arr['rid'] = M("business_progress")->add($map); 

            $c['f_dealerid']  = $dealerId;
            $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
            $c['f_taskid']  = $result['f_taskid'];
            $c['f_proname']  = 'dispatch';
            $c['f_prostatus']  = 0;
            $c['f_protime']  = time();
            M("business_progress")->add($c);

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    // public function dispatchCheck() {
    //     $this->getConf();//取数据
        
    //     $f_id = isset($this->in_arr['f_id'])?$this->in_arr['f_id']:0;
    //     $profile1 = isset($this->in_arr['profile1'])?$this->in_arr['profile1']:0;
    //     $f_dealerid = isset($this->in_arr['f_dealerid'])?$this->in_arr['f_dealerid']:0;

    //     if($f_id==0){
    //         $this->out_arr['result'] = '100000';
    //     }else{

    //         $map['f_userid']  = session('id');
    //         $map['f_prostatus']  = 1;
    //         $map['f_fileid']  = $profile1;
    //         $map['f_protime']  = time();
    //         $this->out_arr['rid'] = M("business_progress")->where('f_id='.$f_id)->save($map); 

    //         $o['f_dealerid']= $f_dealerid;
    //         $result = M('dealerbaseinfo')->where('f_dealerid='.$f_dealerid)->find();
    //         $o['f_taskid']  = $result['f_taskid'];
    //         $o['f_userid']  = session('id');
    //         $o['f_proname']  = 'receive';
    //         $o['f_prostatus']  = 0;
    //         $o['f_protime']  = time();
    //         M("business_progress")->add($o); 


    //         $this->out_arr['result'] = '000000';
    //     }
    //     $this->pushConf();//输出数据
    // }

    public function squareCheck() {
        $this->getConf();//取数据
        
        $dealerid = isset($this->in_arr['dealerid'])?$this->in_arr['dealerid']:0;
        $moneyid = isset($this->in_arr['moneyid'])?$this->in_arr['moneyid']:0;
        $f_dealerid = isset($this->in_arr['f_dealerid'])?$this->in_arr['f_dealerid']:0;
        if($dealerid==0){
            $this->out_arr['result'] = '100000';
        }else{
            $result = M('dealerbaseinfo')->where('f_dealerid='.$f_dealerid)->find();
            $map['f_dealerid']= $f_dealerid;
            $map['f_taskid']  = $result['f_taskid'];
            $map['f_userid']  = session('id');
            $map['f_proname']  = 'commissionsquare';
            $map['f_prostatus']  = 1;
            $map['f_protime']  = time();
            $this->out_arr['rid'] = M("business_progress")->add($map); 

            $o['f_dealerid']= $f_dealerid;
            // $result = M('dealerbaseinfo')->where('f_dealerid='.$f_dealerid)->find();
            $o['f_taskid']  = $result['f_taskid'];
            $o['f_proname']  = 'Settlement';
            $o['f_prostatus']  = 0;
            $o['f_protime']  = time();
            M("business_progress")->add($o); 

            $content = M("dealerbaseinfo")->where('f_dealerid='.$f_dealerid)->find();

            D("Shopsheet")->add_shopsheet('task',$content['f_userid'],1,1,$moneyid,$content['f_taskid'],1,0,0); 


            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    public function settlementCheck() {
        $this->getConf();//取数据
        
        $dealerid = isset($this->in_arr['dealerid'])?$this->in_arr['dealerid']:0;
        $f_dealerid = isset($this->in_arr['f_dealerid'])?$this->in_arr['f_dealerid']:0;
        if($dealerid==0){
            $this->out_arr['result'] = '100000';
        }else{

            $map['f_userid']  = session('id');
            $map['f_prostatus']  = 1;
            $map['f_protime']  = time();
            $this->out_arr['rid'] = M("business_progress")->where('f_id='.$dealerid)->save($map); 

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    public function comContract() {
        $this->getConf();//取数据
        
        $dealerId = isset($this->in_arr['dealerId'])?$this->in_arr['dealerId']:0;
        $profile1 = isset($this->in_arr['profile1'])?$this->in_arr['profile1']:0;
        if($dealerId==0){
            $this->out_arr['result'] = '100000';
        }else{

            $map['f_dealerid']  = $dealerId;
            $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
            $map['f_taskid']  = $result['f_taskid'];
            $map['f_userid']  = cookie('userId');
            $map['f_proname']  = 'contract';
            $map['f_prostatus']  = 2;
            $map['f_fileid']  = $profile1;
            $map['f_protime']  = time();
            $this->out_arr['rid'] = M("business_progress")->add($map); 

            $o['f_dealerid']= $dealerId;
            $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
            $o['f_taskid']  = $result['f_taskid'];
            $o['f_proname']  = 'remit';
            $o['f_prostatus']  = 0;
            $o['f_protime']  = time();
            M("business_progress")->add($o); 

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    public function comDispath() {
        $this->getConf();//取数据
        
        $dealerId = isset($this->in_arr['dealerId'])?$this->in_arr['dealerId']:0;
        $profile1 = isset($this->in_arr['profile1'])?$this->in_arr['profile1']:0;
        if($dealerId==0){
            $this->out_arr['result'] = '100000';
        }else{

            $map['f_dealerid']  = $dealerId;
            $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
            $map['f_taskid']  = $result['f_taskid'];
            $map['f_userid']  = cookie('userId');
            $map['f_proname']  = 'dispatch';
            $map['f_prostatus']  = 1;
            $map['f_fileid']  = $profile1;
            $map['f_protime']  = time();
            $this->out_arr['rid'] = M("business_progress")->add($map); 


            $result = M('dealerbaseinfo')->where('f_dealerid='.$dealerId)->find();
            $o['f_dealerid']= $dealerId;
            $o['f_taskid']  = $result['f_taskid'];
            $o['f_proname']  = 'receive';
            $o['f_prostatus']  = 0;
            $o['f_protime']  = time();
            M("business_progress")->add($o);
                
            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    function getUserDetail($userid){
        $re = A("Api/Jhttp")->getUserinfo2($userid);
        $arr = json_decode($re,true);
        
        return $arr["list"];
    }

    function getCompanyDetail($companyid){
        $re = A("Api/Jhttp")->getCompanyInfo($companyid);
        $arr = json_decode($re,true);

        return $arr["list"];
    }

    /**
     * 审核确认
     */
    public function getConfirm() {
        $this->getConf();//取数据

        $data['f_dealerid'] = $this->in_arr['dealerId'];
        $update['f_dealer_strats'] = '3';
        
        M("dealerbaseinfo")->where($data)->save($update); 

        $j = array("LEFT JOIN t_task ON t_task.f_tid = t_dealerbaseinfo.f_taskid");
        $result = M('dealerbaseinfo')->JOIN($j)->where('f_dealerid='.$data['f_dealerid'])->find();
        $userDetail = $this->getUserDetail($result['f_userid']);
        $companyDetail = $this->getCompanyDetail($result['f_companyid']);
        $time = date("Y/m/d",time());
        $date= explode("/", $time);
        $year=date("Y");
        $month=date("m");
        $day=date("d");
        $number = $year.$month.$day.rand(1000,9999);

        $m['f_authnumber']=$number;
        $m['f_dealerid']=$result['f_dealerid'];
        $m['f_userid']=session("id");
        $m['f_datetime']=time();
        M('authorization')->add($m);

        $p['f_dealerid']=$this->in_arr['dealerId'];
        $p['f_taskid']=$result['f_taskid'];
        $p['f_userid']=session("id");
        $p['f_proname']='bid';
        $p['f_prostatus']=1;
        $p['f_protime']=time();
        M('business_progress')->add($p);

        $c['f_dealerid']=$this->in_arr['dealerId'];
        $c['f_taskid']=$result['f_taskid'];
        $c['f_proname']='contract';
        $c['f_prostatus']=0;
        $c['f_protime']=time();
        M('business_progress')->add($c);

        $this->out_arr['result'] = '000000';

        $this->pushConf();//输出数据
    }

    public function getDealerListNo() {
        $this->getConf();//取数据
        $map['f_taskid'] = $this->in_arr['taskid'];
        if(isset($this->in_arr['userid'])){
            $map['f_userid'] = $this->in_arr['userid'];
        }
        $t = M('dealerbaseinfo');
        $model = new \Think\Model();
        $subQuery = $t->group('f_companynameone')->where($map)->buildSql();
        $total = $model->table($subQuery.' a')->where($map)->count();//总记录数
        
        $pageSize = 18; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        $this->out_arr['totalPage'] = $totalPage;
        $this->pushConf();//输出数据
    }
    
    
    public function getDealerList(){
        $this->getConf();//取数据
        
        $map['f_taskid'] = $this->in_arr['taskid'];
        if(isset($this->in_arr['userid'])){
            $map['f_userid'] = $this->in_arr['userid'];
        }
        $page = $this->in_arr['page'];
        if($page==0 || $page==""){
            $page = 1;
        }
        $t = M('dealerbaseinfo');
        $model = new \Think\Model();
        $subQuery = $t->group('f_companynameone')->where($map)->buildSql();
        $total = $model->table($subQuery.' a')->where($map)->count();//总记录数
        //echo $t->getLastsql();
        $pageSize = 15; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;
        
        $f="";
        $j=array("LEFT JOIN t_dealerqualifyinfo ON t_dealerqualifyinfo.f_dealerid = t_dealerbaseinfo.f_dealerid");
        
        $this->out_arr['list'] = $t->field($f)->where($map)->page($page.','.$pageSize)->join($j)->order('t_dealerbaseinfo.f_dealerid desc')->group('f_companynameone')->select();
        foreach ($this->out_arr['list'] as $key => $value) {
            $userDetails = A('Api/Jhttp')->getUserinfo2($value['f_userid']);
            $arr=json_decode($userDetails,true);
            $this->out_arr['list'][$key]['trueName'] = $arr['list']['trueName']; 
        }
        // var_dump($this->out_arr['list']);exit();
        $this->pushConf();//输出数据
    }

    
    
    //随手赚任务列表
    public function  get_track_earn(){
        $this->getConf();//取数据
        $companyid = $this->in_arr['companyid'];
        $tid=$this->in_arr['taskid'];
        $page=$this->in_arr['page'];
        $utask_status = $this->in_arr['utask_status'];
         if($companyid!=0){
            $map['t_task.f_companyid'] = $companyid;
         }
         if($page==0 || $page==""){
            $page = 1;
         }
         $map['t_task.f_status']  = array('neq',0);
         $map['t_task.f_tid']=$tid;
            //根据任务标题分组出参与的用户

         //查看认领的任务userid
         $Model=new \Think\Model();
         $total=$Model->query("SELECT COUNT(1) AS num FROM (SELECT * FROM t_taskdraw t WHERE  t.f_taskid=".$tid." AND  t.f_utask_status=".$utask_status."  GROUP BY t.f_userid) AS temp");
         $total =$total[0]['num'];//总记录数
         $pageSize = 15; //每页显示数
         $totalPage = ceil($total/$pageSize); //总页数
          //构造数组
         $this->out_arr['page'] = $page;
         $this->out_arr['total'] = $total;
         $this->out_arr['pageSize'] = $pageSize;
         $this->out_arr['totalPage'] = $totalPage;
         
         $Model1=new \Think\Model();
       
         //分页
        //  "SELECT * FROM (SELECT * FROM t_taskdraw t WHERE  t.f_taskid=".$tid." AND  t.f_utask_status=1  GROUP BY t.f_userid) AS temp  ORDER BY temp.f_drawdate  DESC"
                 
         $subQuery=M('taskdraw')->where("f_taskid=".$tid." AND  f_utask_status=".$utask_status)->group("f_userid")->buildSql();
         //echo M('taskdraw')->getLastSql();
         //exit;
         $list = $Model1->table($subQuery.' a')->order("a.f_drawdate desc")->page($page.','.$pageSize)->select();//总记录数
         //echo $Model1->getLastSql();
         //exit;
         foreach ($list as $key => $val) {
            $userid=$val['f_userid'];
            $titleId=$val['f_taskid'];
            $drawdate=$val['f_drawdate'];
            $taskStatus=$val['f_utask_status'];
            $userlist=A('Jhttp')->getUserinfo2($userid);
            $arr=json_decode($userlist,true);
         if($arr['resCode']=='000000'){
            $truename = $arr['list']['trueName']; 
            $mobile=$arr['list']['mobile'];  
          }   
          //任务类型
          $t = M('task')->field("f_tasktypeid,f_typename")->join("t_tasktype t on t_task.f_tasktypeid=t.f_typeid")->where("t_task.f_tid=".$tid."")->select();
          
          $this->out_arr["list"][$key]["userid"]=$userid;
          $this->out_arr["list"][$key]["truename"]=$truename==""?$mobile:$truename;
          $this->out_arr["list"][$key]["submitdate"]=$drawdate;
          $this->out_arr["list"][$key]["submitdate"]=$drawdate;
          $this->out_arr["list"][$key]["taskStatus"]=$taskStatus;
          $this->out_arr["list"][$key]["titleId"]=$titleId;
          $this->out_arr["list"][$key]["typename"]=$t[0]['f_typename'];
         }
         $this->out_arr['list'];
         $this->pushConf();//输出数据
    
    }
    //答案显示
     public  function  trackearn_answer(){
         $this->getConf();//取数据
         $tid=$this->in_arr['tid'];
         $submituserid=$this->in_arr['submituserid'];
         //查找该用户该任务下的报告详情
         $answerid=M('surveyanswer')->field("f_answerid")->where('f_taskid='.$tid.' and f_submituserid='.$submituserid)->select();
         //echo $answerid[0]['f_answerid'];
         //dump($answerid);
         $list=M('surveyanswerdetail')->join("t_surveytaskdetail  t2  ON t_surveyanswerdetail.f_serial=t2.f_serial")->where('t2.f_taskid='.$tid.' and  t_surveyanswerdetail.f_answerid='.$answerid[0]['f_answerid'])->select();
        // echo  $list->getLastSql();
         $this->out_arr['list']=$list;
         $this->pushConf();//输出数据
    }
   
   //审核答案
    public  function  trackearn_shenhe(){
       $this->getConf();
       //$checklist=$this->in_arr['checklist'];
       $tid=$this->in_arr['tid'];
       $obj=M('taskdraw');
       $idarray=  explode(',',$this->in_arr['checklist']);
       //pt($idarray);
       //exit;
       //echo count($idarray);
       //$checklist1=split($checklist, ',');
       for($i=0;$i<count($idarray);$i++){
           //echo $idarray[$i];
           $map['f_userid'] = $idarray[$i];
           $map['f_taskid'] = $tid;
           $map['f_utask_status'] =1;
           //pt($map);
           $reV=$obj->where($map)->setField('f_utask_status',3);
           
           //$reV=$obj->where('f_userid='.$idarray[$i].' and f_taskid='.$tid.'and f_utask_status=1')->setField('f_utask_status','3');
          //echo $obj->getLastSql();
          //exit;
           //echo $reV;
           if($reV==0){
               
               $this->out_arr['error_code']='false';
           }else{
               $re_taskinfo = M('tasksmallinfo')->where("f_taskid=".$map['f_taskid'])->find();
               //echo M('tasksmallinfo')->getLastSql();
               //exit;
               D('Shopsheet')->add_shopsheet('task',$map['f_userid'],1,1,$re_taskinfo['f_eachcoin']*10,$map['f_taskid'],2,0);
               D('Shopsheet')->add_shopsheet('task',$map['f_userid'],1,2,$re_taskinfo['f_eachscore'],$map['f_taskid'],2,0);
               $this->out_arr['error_code']='true';
           }    
       }
       $this->pushConf();//输出数据
    }
    
    //业务员列员
    public function getSalesListNo() {
        $this->getConf();//取数据
        
        $pageSize = 18; //每页显示数
        
        $page = $this->in_arr['page'];
        $tabType = $this->in_arr['tabType'];
        if($page==0 || $page=="" || $page==1){
            $page = 1;
            $queryStart=1;
            $queryEnd=$pageSize;
        }else{
            $queryStart=($page-1)*$pageSize+1;
            $queryEnd=$page*$pageSize;
        }

        switch($tabType){
            case '0'://全部业务员
               $re = A('Jhttp')->getUsersInfo($this->in_arr['companyid'],$queryStart,$queryEnd,0);
               $arr = json_decode($re,true);
               break;
            case '1'://实名认证的业务员
               $re = A('Jhttp')->getUsersInfo($this->in_arr['companyid'],$queryStart,$queryEnd,1);
               $arr = json_decode($re,true);
               break;
            case '2'://银行卡绑定业务员
                $f['f_status']=0;
                $arr['list']=M('useraccount')->field("f_userid as userId")->where($f)->group("f_userid")->select();
                $arr['count'] = count($arr['list']);
                $arr['resCode']='000000';
                foreach ( $arr['list'] as $i=>$val ) {
                    foreach($val as $k=>$v)
                    {
                        $arr['list'][$i]['userId'] = $v;
                        unset($arr['list'][$i][$k]);
                    }
                }
               break;
            default:
               break;
        }

        if($arr['resCode']=='000000'){
            $total = $arr['count'];
        }else{
            $total = 0;
        }

        $totalPage = ceil($total/$pageSize); //总页数
        $this->out_arr['totalPage'] = $totalPage;
        $this->pushConf();//输出数据
    }
    
    
    public function getSalesList(){
        $this->getConf();//取数据
        
        $pageSize = 18; //每页显示数
        
        $page = $this->in_arr['page'];
        $tabType = $this->in_arr['tabType'];
        if($page==0 || $page=="" || $page==1){
            $page = 1;
            $queryStart=1;
            $queryEnd=$pageSize;
        }else{
            $queryStart=($page-1)*$pageSize+1;
            $queryEnd=$page*$pageSize;
        }

        switch($tabType){
            case '0'://全部业务员
               $re = A('Jhttp')->getUsersInfo($this->in_arr['companyid'],$queryStart,$queryEnd,0);
               $arr = json_decode($re,true);
               break;
            case '1'://实名认证的业务员
               $re = A('Jhttp')->getUsersInfo($this->in_arr['companyid'],$queryStart,$queryEnd,1);
               $arr = json_decode($re,true);
               break;
            case '2'://银行卡绑定业务员
                $f['f_status']=0;
                $arr['list']=M('useraccount')->field("f_userid as userId")->where($f)->group("f_userid")->limit($queryStart-1,$queryEnd)->select();
                $arr['count'] = count($arr['list']);
                $arr['resCode']='000000';
                foreach ( $arr['list'] as $i=>$val ) {
                    foreach($val as $k=>$v)
                    {
                        $arr['list'][$i]['userId'] = $v;
                        unset($arr['list'][$i][$k]);
                    }
                }
               break;
            default:
               break;
        }

        if($arr['resCode']=='000000'){
            $total = $arr['count'];
        }else{
            $total = 0;
        }
        
        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;

        //查金币，银票
        foreach ($arr['list'] as $key => $val) {
            $re_g = M('userbalance')->where('f_userid='.$val['userId'])->find();
            $re_d = M('taskdraw')->where('f_userid='.$val['userId'])->count('distinct(f_taskid)');
            $arr['list'][$key]['goldcoin'] = $re_g['f_goldcoin'];
            $arr['list'][$key]['credit'] = $re_g['f_credit'];
            $arr['list'][$key]['taskdrawsum'] = $re_d;
            // $arr['list'][$key]['total'] = $total;
            if ($tabType == 2) {
                $userDetails = A('Api/Jhttp')->getUserinfo2($val['userId']);
                $result=json_decode($userDetails,true);
                $arr['list'][$key]['nickName'] = $result['list']['nickName']; 
                $arr['list'][$key]['trueName'] = $result['list']['trueName']; 
                $arr['list'][$key]['mobile'] = $result['list']['mobile']; 
            }
        }

        $this->out_arr['list'] = $arr['list'];
        //pt($this->out_arr['list']);
        $this->pushConf();//输出数据
    }
    
    
    //企业列表
    public function getCompanyListNo() {
        $this->getConf();//取数据
        $map['f_taskid'] = $this->in_arr['taskid'];
        if(isset($this->in_arr['userid'])){
            $map['f_userid'] = $this->in_arr['userid'];
        }
        $t = M('dealerbaseinfo');
        $model = new \Think\Model();
        $subQuery = $t->group('f_companynameone')->where($map)->buildSql();
        $total = $model->table($subQuery.' a')->where($map)->count();//总记录数
        
        $pageSize = 18; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        $this->out_arr['totalPage'] = $totalPage;
        $this->pushConf();//输出数据
    }  
    
    public function getCompanyList(){
        $this->getConf();//取数据
        
        $map['f_taskid'] = $this->in_arr['taskid'];
        if(isset($this->in_arr['userid'])){
            $map['f_userid'] = $this->in_arr['userid'];
        }
        $page = $this->in_arr['page'];
        if($page==0 || $page==""){
            $page = 1;
        }
        $t = M('dealerbaseinfo');
        $model = new \Think\Model();
        $subQuery = $t->group('f_companynameone')->where($map)->buildSql();
        $total = $model->table($subQuery.' a')->where($map)->count();//总记录数
        //echo $t->getLastsql();
        $pageSize = 18; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;
        
        $f="";
        $j=array("LEFT JOIN t_dealerqualifyinfo ON t_dealerqualifyinfo.f_dealerid = t_dealerbaseinfo.f_dealerid");
        
        $this->out_arr['list'] = $t->field($f)->where($map)->page($page.','.$pageSize)->join($j)->order('t_dealerbaseinfo.f_dealerid desc')->group('f_companynameone')->select();
        
        $this->pushConf();//输出数据
    }

    //是否有合同
    public function isContract(){
        $this->getConf();//取数据
        
        $dealerid = isset($this->in_arr['dealerid'])?$this->in_arr['dealerid']:0;

        if($dealerid==0){
            $this->out_arr['result'] = '100000';
        }else{

            $map['f_proname']= 'contract';
            $map['f_prostatus']= 1;
            $map['f_dealerid']= $dealerid;
            $this->out_arr['contractOne'] = M("business_progress")->where($map)->find(); 

            $map['f_proname']= 'contract';
            $map['f_prostatus']= 2;
            $map['f_dealerid']= $dealerid;
            $this->out_arr['contractTwo'] = M("business_progress")->where($map)->find(); 

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    //判断是否打款
    public function isRemit(){
        $this->getConf();//取数据
        
        $dealerid = isset($this->in_arr['dealerid'])?$this->in_arr['dealerid']:0;

        if($dealerid==0){
            $this->out_arr['result'] = '100000';
        }else{

            $map['f_proname']= 'remit';
            $map['f_prostatus']= 1;
            $map['f_dealerid']= $dealerid;
            $this->out_arr['remitOne'] = M("business_progress")->where($map)->find(); 

            $map['f_proname']= 'remit';
            $map['f_prostatus']= 2;
            $map['f_dealerid']= $dealerid;
            $this->out_arr['remitTwo'] = M("business_progress")->where($map)->find(); 

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    //判断是否发货
    public function isDispatch(){
        $this->getConf();//取数据
        
        $dealerid = isset($this->in_arr['dealerid'])?$this->in_arr['dealerid']:0;

        if($dealerid==0){
            $this->out_arr['result'] = '100000';
        }else{

            $map['f_proname']= 'dispatch';
            $map['f_prostatus']= 0;
            $map['f_dealerid']= $dealerid;
            $this->out_arr['dispatchOne'] = M("business_progress")->where($map)->find(); 

            $map['f_proname']= 'dispatch';
            $map['f_prostatus']= 1;
            $map['f_dealerid']= $dealerid;
            $this->out_arr['dispatchTwo'] = M("business_progress")->where($map)->find(); 

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    //判断是否收货
    public function isReceive(){
        $this->getConf();//取数据
        
        $dealerid = isset($this->in_arr['dealerid'])?$this->in_arr['dealerid']:0;

        if($dealerid==0){
            $this->out_arr['result'] = '100000';
        }else{

            $map['f_proname']= 'receive';
            $map['f_prostatus']= 1;
            $map['f_dealerid']= $dealerid;
            $this->out_arr['receive'] = M("business_progress")->where($map)->find(); 

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    //判断是否结算
    public function isSettlement(){
        $this->getConf();//取数据
        
        $dealerid = isset($this->in_arr['dealerid'])?$this->in_arr['dealerid']:0;

        if($dealerid==0){
            $this->out_arr['result'] = '100000';
        }else{

            $map['f_proname']= 'Settlement';
            $map['f_prostatus']= 1;
            $map['f_dealerid']= $dealerid;
            $this->out_arr['Settlement'] = M("business_progress")->where($map)->find(); 

            $this->out_arr['result'] = '000000';
        }
        $this->pushConf();//输出数据
    }

    public function getAllCompanyListNo() {
        $this->getConf();//取数据
        $pageSize = 18; //每页显示数
        
        $page = $this->in_arr['page'];
        $state = $this->in_arr['state'];
        if($page==0 || $page=="" || $page==1){
            $page = 1;
            $queryStart=0;
            $queryEnd=$pageSize;
        }else{
            $queryStart=($page-1)*$pageSize;
            $queryEnd=$page*$pageSize;
        }

        $re = A('Jhttp')->getAllCompanyInfo(0,0,$state);
        $arr = json_decode($re,true);
        $total = $arr['count'];
        $totalPage = ceil($total/$pageSize); //总页数
        $this->out_arr['totalPage'] = $totalPage;
        $this->pushConf();//输出数据
    }
    
    
    public function getAllCompanyList(){
        $this->getConf();//取数据
        
        $pageSize = 18; //每页显示数
        
        $page = $this->in_arr['page'];
        $state = $this->in_arr['state'];
        if($page==0 || $page=="" || $page==1){
            $page = 1;
            $queryStart=0;
            $queryEnd=$pageSize;
        }else{
            $queryStart=($page-1)*$pageSize;
            $queryEnd=$page*$pageSize;
        }
        $re = A('Jhttp')->getAllCompanyInfo(0,0,$state);
        $arr = json_decode($re,true);
        $total = $arr['count'];

        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;

        $res = A('Jhttp')->getAllCompanyInfo($queryStart,$queryEnd,$state);
        $arrs = json_decode($res,true);

        if ($arrs['resCode']=="000000") {
            $this->out_arr['list'] = $arrs['list'];
        }else{
            $this->out_arr['resCode'] = $arrs['resCode'];
        }
        
        
        $this->pushConf();//输出数据
    }   

    //招商进程列表
    public function getDealerProListNo() {
        $this->getConf();//取数据
        
        $pageSize = 18; //每页显示数
        
        $page = $this->in_arr['page'];
        if($page==0 || $page==""){
            $page = 1;
        }
        $tabType = $this->in_arr['tabType'];

        $t = M('business_progress');

        switch($tabType){
            case '0'://全部
                $total = $t->count("distinct f_dealerid");//总记录数
               break;
            case '1'://有授权书
                $map['f_proname']  = 'bid';
                $map['f_prostatus']  = 1;
                $total = $t->where($map)->count();//总记录数
               break;
            case '2'://有合同
                $map['f_proname']  = 'contract';
                // $map['f_prostatus']  = array('neq',0);
                $total = $t->where($map)->count();//总记录数
               break;
           case '3'://已打款
                $map['f_proname']  = 'remit';
                $map['f_prostatus']  = array('neq',0);
                $total = $t->where($map)->count();//总记录数
               break;
           case '4'://已发货
                $map['f_proname']  = 'dispatch';
                // $map['f_prostatus']  = 1;
                $total = $t->where($map)->count();//总记录数
               break;
           case '5'://已收货
                $map['f_proname']  = 'receive';
                // $map['f_prostatus']  = 1;
                $total = $t->where($map)->count();//总记录数
               break;
           case '6'://佣金结算
                $map['f_proname']  = 'commissionsquare';
                // $map['f_prostatus']  = 1;
                $total = $t->where($map)->count();//总记录数
               break;
           case '7'://货款结算
                $map['f_proname']  = 'Settlement';
                $total = $t->where($map)->count();//总记录数
               break;
            default:
               break;
        }

        $totalPage = ceil($total/$pageSize); //总页数
        $this->out_arr['totalPage'] = $totalPage;
        $this->pushConf();//输出数据
    }
    
    
    public function getDealerProList(){
        $this->getConf();//取数据
        
        $pageSize = 18; //每页显示数
        
        $page = $this->in_arr['page'];
        if($page==0 || $page==""){
            $page = 1;
        }
        $tabType = $this->in_arr['tabType'];

        $t = M('business_progress');

        switch($tabType){
            case '0'://全部
                $total = $t->count("distinct f_dealerid");//总记录数
                $j=array("LEFT JOIN t_dealerbaseinfo ON t_dealerbaseinfo.f_dealerid = t_business_progress.f_dealerid");
                $this->out_arr['list'] = $t->page($page.','.$pageSize)->join($j)->group('t_business_progress.f_dealerid')->order('t_business_progress.f_id desc')->select();
                // var_dump($this->out_arr['list']);exit();
                foreach ($this->out_arr['list'] as $key => $value) {
                    $this->out_arr['list'][$key]['user'] = $this->getUserDetail($value['f_userid']);
                    $this->out_arr['list'][$key]['f_protime'] = date("Y/m/d",$value['f_protime']);
                }
                // var_dump($this->out_arr['list']);exit();
               break;
            case '1'://有授权书
                $map['f_proname']  = 'bid';
                $map['f_prostatus']  = 1;
                $total = $t->where($map)->count();//总记录数
                $j=array("LEFT JOIN t_dealerbaseinfo ON t_dealerbaseinfo.f_dealerid = t_business_progress.f_dealerid");
                $this->out_arr['list'] = $t->where($map)->page($page.','.$pageSize)->join($j)->select();
                foreach ($this->out_arr['list'] as $key => $value) {
                    $this->out_arr['list'][$key]['user'] = $this->getUserDetail($value['f_userid']);
                    $this->out_arr['list'][$key]['f_protime'] = date("Y/m/d",$value['f_protime']);
                }
               break;
            case '2'://有合同
                $map['f_proname']  = 'contract';
                // $map['f_prostatus']  = array('neq',0);
                $total = $t->where($map)->count();//总记录数
                $j=array("LEFT JOIN t_dealerbaseinfo ON t_dealerbaseinfo.f_dealerid = t_business_progress.f_dealerid");
                $this->out_arr['list'] = $t->where($map)->page($page.','.$pageSize)->join($j)->select();
                foreach ($this->out_arr['list'] as $key => $value) {
                    $this->out_arr['list'][$key]['user'] = $this->getUserDetail($value['f_userid']);
                    $this->out_arr['list'][$key]['f_protime'] = date("Y/m/d",$value['f_protime']);
                }
               break;
           case '3'://已打款
                $map['f_proname']  = 'remit';
                $map['f_prostatus']  = array('neq',0);
                $total = $t->where($map)->count();//总记录数
                $j=array("LEFT JOIN t_dealerbaseinfo ON t_dealerbaseinfo.f_dealerid = t_business_progress.f_dealerid");
                $this->out_arr['list'] = $t->where($map)->page($page.','.$pageSize)->join($j)->select();
                foreach ($this->out_arr['list'] as $key => $value) {
                    $this->out_arr['list'][$key]['user'] = $this->getUserDetail($value['f_userid']);
                    $this->out_arr['list'][$key]['f_protime'] = date("Y/m/d",$value['f_protime']);
                }
               break;
           case '4'://已发货
                $map['f_proname']  = 'dispatch';
                // $map['f_prostatus']  = 1;
                $total = $t->where($map)->count();//总记录数
                $j=array("LEFT JOIN t_dealerbaseinfo ON t_dealerbaseinfo.f_dealerid = t_business_progress.f_dealerid");
                $this->out_arr['list'] = $t->where($map)->page($page.','.$pageSize)->join($j)->select();
                foreach ($this->out_arr['list'] as $key => $value) {
                    $this->out_arr['list'][$key]['user'] = $this->getUserDetail($value['f_userid']);
                    $this->out_arr['list'][$key]['f_protime'] = date("Y/m/d",$value['f_protime']);
                }
               break;
           case '5'://已收货
                $map['f_proname']  = 'receive';
                // $map['f_prostatus']  = 1;
                $total = $t->where($map)->count();//总记录数
                $j=array("LEFT JOIN t_dealerbaseinfo ON t_dealerbaseinfo.f_dealerid = t_business_progress.f_dealerid");
                $this->out_arr['list'] = $t->where($map)->page($page.','.$pageSize)->join($j)->select();
                foreach ($this->out_arr['list'] as $key => $value) {
                    $this->out_arr['list'][$key]['user'] = $this->getUserDetail($value['f_userid']);
                    $this->out_arr['list'][$key]['f_protime'] = date("Y/m/d",$value['f_protime']);
                }
               break;
           case '6'://佣金结算
                $map['f_proname']  = 'commissionsquare';
                $total = $t->where($map)->count();//总记录数
                $j=array("LEFT JOIN t_dealerbaseinfo ON t_dealerbaseinfo.f_dealerid = t_business_progress.f_dealerid LEFT JOIN t_taskmtbaseinfo ON t_taskmtbaseinfo.f_taskid = t_dealerbaseinfo.f_taskid");
                $this->out_arr['list'] = $t->where($map)->page($page.','.$pageSize)->join($j)->select();
                foreach ($this->out_arr['list'] as $key => $value) {
                    $this->out_arr['list'][$key]['user'] = $this->getUserDetail($value['f_userid']);
                    $this->out_arr['list'][$key]['f_protime'] = date("Y/m/d",$value['f_protime']);
                }
                // var_dump($this->out_arr['list']);
               break;
           case '7'://货款结算
                $map['f_proname']  = 'Settlement';
                $total = $t->where($map)->count();//总记录数
                $j=array("LEFT JOIN t_dealerbaseinfo ON t_dealerbaseinfo.f_dealerid = t_business_progress.f_dealerid");
                $this->out_arr['list'] = $t->where($map)->page($page.','.$pageSize)->join($j)->select();
                foreach ($this->out_arr['list'] as $key => $value) {
                    $this->out_arr['list'][$key]['user'] = $this->getUserDetail($value['f_userid']);
                    $this->out_arr['list'][$key]['f_protime'] = date("Y/m/d",$value['f_protime']);
                }
               break;
            default:
               break;
        }
        
        $totalPage = ceil($total/$pageSize); //总页数
        //构造数组
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;

        $this->pushConf();//输出数据
    }

    //推广赚列表显示
   function  get_track_make(){
        $this->getConf();//取数据 
        $tid=$this->in_arr['taskid'];
        $page=$this->in_arr['page'];
        $t = M('share');
        if($page==0 || $page==""){
            $page = 1;
         }
         $j=array("LEFT JOIN t_share ON t_share.f_taskid=t_task.f_tid");
         $Model=new \Think\Model();
         $total=$Model->query("SELECT COUNT(1) AS total FROM (SELECT * FROM t_share t WHERE t.f_taskid=".$tid." GROUP BY t.f_userid) AS temp");
         $total =$total[0]['total'];//总记录数
         $pageSize = 20; //每页显示数
         $totalPage = ceil($total/$pageSize); //总页数
          //构造数组
         $this->out_arr['page'] = $page;
         $this->out_arr['total'] = $total;
         $this->out_arr['pageSize'] = $pageSize;
         $this->out_arr['totalPage'] = $totalPage;
         //根据tid查找用户
         $userid=$t->field("f_userid")->where("t_share.f_taskid=".$tid."")->group('t_share.f_userid')->page($page.','.$pageSize)->select();
         foreach ($userid as $key => $val) {
             $userid=$val['f_userid'];
             $userlist=A('Jhttp')->getUserinfo2($userid);
                $arr=json_decode($userlist,true);
                if($arr['resCode']=='000000'){
                    $truename = $arr['list']['trueName']; 
                    $mobile=$arr['list']['mobile'];
                }
             $map["f_taskid"]=$tid;
             $map["f_userid"]=$userid;
             $map["f_platform"]=array('neq',"");
             $list = M("share")->field("COUNT(*) num,f_platform")->where($map)->group("f_platform")->select();
             $this->out_arr["list"][$key]["userid"]=$userid;
             $this->out_arr["list"][$key]["truename"]=$truename==""?$mobile:$truename;
             $this->out_arr["list"][$key]["numlist"]=$list==null?0:$list;   
         } 
         $this->out_arr['list']; 
         $this->pushConf();//输出数据 
   }
   
   function  get_track_makeTotal(){
        $this->getConf();//取数据 
        $tid=$this->in_arr['taskid'];
        $list=M('share')->field("count(*) num,f_platform")->where("f_taskid = ".$tid." and f_platform  <> '' ")->group("f_platform")->select();
        $this->out_arr['listtotal']=$list; 
        $this->pushConf();//输出数据 
   }
   
   function gettasktitle(){
        $this->getConf();//取数据
        $tasktypeid = $this->in_arr['tasktypeid'];
        $companyid = $this->in_arr['companyid'];
        $in_Id = A('Fun')->getTaskTypeId($tasktypeid);
        $t = M('task');
        if($tasktypeid!=0){
            $map['f_tasktypeid'] = array('in',$in_Id);
         }
         if($companyid!=0){
            $map['f_companyid'] = $companyid;
         }
         $map['f_status']  = array('eq',3);
        if($tasktypeid==1){
            $f = "";
            $j = array("LEFT JOIN t_tasktype ON t_tasktype.f_typeid = t_task.f_tasktypeid");
        }elseif($tasktypeid==2 || $tasktypeid==4 || $tasktypeid==5 || $tasktypeid==6){
            $f = "";
            $j = array("LEFT JOIN t_tasktype ON t_tasktype.f_typeid = t_task.f_tasktypeid");
        }else{
            $f = "";
            $j = array("LEFT JOIN t_tasktype ON t_tasktype.f_typeid = t_task.f_tasktypeid","LEFT JOIN t_taskmtbaseinfo ON t_taskmtbaseinfo.f_taskid = t_task.f_tid");
        }

        $this->out_arr['list'] = $t->field($f)->where($map)->join($j)->order('f_creatdate desc')->select();
        $this->pushConf();//输出数据
   }
   
   //厂家获取经销商数据
   function  get_business_dealer(){
       $this->getConf();
       $taskid=$this->in_arr["taskid"];
       $dealer_status=$this->in_arr["dealer_status"];
       $type=$this->in_arr["type"];
//       echo $type;
//       exit;
       $page=$this->in_arr["page"];
       if($page==0 || $page==""){
            $page = 1;
       }
       
       if($type==3){
       $map['f_taskid']=$taskid;
       $map['f_dealer_strats']=$dealer_status;
       $list=M('dealerbaseinfo')->join("t_dealerqualifyinfo  t2 on t_dealerbaseinfo.f_dealerid=t2.f_dealerid")->where($map)->select(); 
       //分页
       $total =M('dealerbaseinfo')->join("t_dealerqualifyinfo  t2 on t_dealerbaseinfo.f_dealerid=t2.f_dealerid")->where($map)->count();//总记录数
       $pageSize =20; //每页显示数
       $totalPage = ceil($total/$pageSize); //总页数
          //构造数组
       $this->out_arr['page'] = $page;
       $this->out_arr['total'] = $total;
       $this->out_arr['pageSize'] = $pageSize;
       $this->out_arr['totalPage'] = $totalPage;
       $this->out_arr['list']=$list;
       }
       if($type==1){
           $map['f_taskid']=$taskid;
           $map['f_dealer_strats']=$dealer_status;
           $list1=M('dealerbaseinfo')->join("t_dealerqualifyinfo  t2 on t_dealerbaseinfo.f_dealerid=t2.f_dealerid")->where($map)->select(); 
           foreach ($list1 as $key => $val) {
             $userid=$val['f_userid'];
             $userlist=A('Jhttp')->getUserinfo2($userid);
                $arr=json_decode($userlist,true);
                if($arr['resCode']=='000000'){
                    $truename = $arr['list']['trueName']; 
                    $mobile=$arr['list']['mobile'];
                    $idcard=$arr['list']['idCard'];
                }
             $this->out_arr["list"][$key]["userid"]=$userid;
             $this->out_arr["list"][$key]["idcard"]=$idcard;
             $this->out_arr["list"][$key]["truename"]=$truename==""?$mobile:$truename;
             $this->out_arr['list'][$key]['mobile']=$mobile;
             $this->out_arr["list"][$key]["dealerlist"]=$val==null?0:$val;   
         }
           //分页
           $total =M('dealerbaseinfo')->join("t_dealerqualifyinfo  t2 on t_dealerbaseinfo.f_dealerid=t2.f_dealerid")->where($map)->count();//总记录数
           $pageSize = 6; //每页显示数
           $totalPage = ceil($total/$pageSize); //总页数
          //构造数组
           $this->out_arr['page'] = $page;
           $this->out_arr['total'] = $total;
           $this->out_arr['pageSize'] = $pageSize;
           $this->out_arr['totalPage'] = $totalPage;
           $this->out_arr['list'];
       }
       
       $this->pushConf();
        
   }
   
   //获取业务员信息
   function  getUser(){
     $this->getConf(); 
     $re = A('Jhttp')->getUserinfo2($this->in_arr['userid']);
     $arr = json_decode($re,true);
     $this->out_arr["list"]=$arr['list'];
     $this->pushConf();

   }
   
   //经销商详情
   function getdetaldealer2(){
       $this->getConf();
       $dealerid=$this->in_arr["dealerid"];
       //echo  $dealerid;
       $map['t_dealerbaseinfo.f_dealerid']=$dealerid;
       $re=M('dealerbaseinfo')->join("t_dealerqualifyinfo  t2 on t_dealerbaseinfo.f_dealerid=t2.f_dealerid")->where($map)->select(); 
       //echo M("dealerbaseinfo")->getLastSql();
       $this->out_arr['list']=$re[0];
       $this->pushConf();  
   }
   
   //经销商中标操作
   function  dealerselected(){
       $this->getConf();
       $obj=M('dealerbaseinfo');
       $idarray=explode(',',I('post.checklist'));
       for($i=0;$i<count($idarray);$i++){
           $map['f_dealerid'] = $idarray[$i];
           $map['f_dealer_strats'] =3;
           $reV=$obj->where($map)->setField('f_dealer_strats',1);
           if($reV==0){
               $this->out_arr['error_code']='false';
           }else{
//               $re_taskinfo = M('tasksmallinfo')->where("f_taskid=".$map['f_taskid'])->find();
//             
//               D('Shopsheet')->add_shopsheet('task',$map['f_userid'],1,1,$re_taskinfo['f_eachcoin']*10,$map['f_taskid'],2,0);
//               D('Shopsheet')->add_shopsheet('task',$map['f_userid'],1,2,$re_taskinfo['f_eachscore'],$map['f_taskid'],2,0);
               $this->out_arr['error_code']='true';
           }    
       }
       $this->pushConf();
   }
   
   
   //招商目标与实际目标的统计 与招商回款统计  经销商情况的统计
     function  InvTargetstatistics(){
         $this->getConf();
         $taskid=$this->in_arr['taskid']; 
         //实际招商
         $Actinvestment=0;
         //实际回款=经销商签订合同并打款数量
         $actualpayment=0;
         //签订合同经销商数量
         $contsignednum=0;
         //预计回款=签订合同数*总首批款
         $expectedmoney=0;
         //实际打款金额合计
         $actualtotalpay=0;
         $re=M('taskmtareaqty')->where("f_taskid =".$taskid)->sum("f_qty");
         $re2=M('taskmtbaseinfo')->where('f_taskid ='.$taskid)->find();
         $re3=M('dealerbaseinfo')->where('f_taskid ='.$taskid.' and  f_dealer_strats = 3')->count();
         $re4=M('dealerbaseinfo')->where('f_taskid ='.$taskid.' and f_dealer_strats = 1')->count();
         //取招商数量前五的区域
         $re5=M('taskmtareaqty')->where('f_taskid ='.$taskid)->order('f_qty')->limit(5)->select();
         $Invtarget=$re!=""?$re:0;
         $collecttarget=($re2['f_unittotalamount']!=0?$re2['f_unittotalamount']:0)*$Invtarget;
         $Redealnum=$re3!=0?$re3:0;  //上报经销商数量
         $Authdealnum=$re4!=0?$re4:0;  //授权经销商数量
         $this->out_arr['Invtarget']=$Invtarget;  //招商目标
         $this->out_arr['Actinvestment']=$Actinvestment; //实际招商(签订合同的经销商数量)
         $this->out_arr['payarr']=array($collecttarget,$actualpayment);
         $this->out_arr['collecttarget']=$collecttarget;//回款目标
         $this->out_arr['actualpayment']=$actualpayment;//经销商签订合同并打款合计（实际回款）
         $this->out_arr['redealnum']=($Redealnum+$Authdealnum+$contsignednum);//上报经销商数量
         $this->out_arr['authdealnum']=($Authdealnum+$contsignednum); //授权经销商数量
         $this->out_arr['contsignednum']=$contsignednum;//签订合同经销商数量
         $this->out_arr['expectedmoney']=$expectedmoney;//预计回款=签订合同数*总首批款
         $this->out_arr['actualtotalpay']=$actualtotalpay; //打款金额合计
         $this->out_arr['Invareasort']=$re5;//招商区域取前五
         $this->pushConf();
     }
   
     //推广赚与随手赚报表呈现
     function  promReport(){
         $this->getConf();
         $taskid=$this->in_arr['taskid']; 
         $type=$this->in_arr['type'];
         $re=M("tasksmallinfo")->where("f_taskid=".$taskid)->select();
         //发布任务数量
         $targetcopies=$re[0]['f_totalcopies'];
         //单份任务金币
         $eachcoin=$re[0]['f_eachcoin'];
         //总奖励金币
         $totalcopies=$targetcopies*$eachcoin;
         //推广
         $this->out_arr["targetcopies"]=$targetcopies;  //发布任务数量
         $this->out_arr['eachcoin']=$eachcoin; //单份任务金币
         $this->out_arr['totalcopies']=$totalcopies;  //总奖励金币
         if($type==1){
            //参与数量
            $propartnum=M(share)->where("f_taskid =".$taskid)->count();   
            //已发奖励金币
            $projiangnum=$propartnum*$eachcoin; 
            $this->out_arr['propartnum']=$propartnum!=0?$propartnum:0; //推广参与数量
            $this->out_arr['projiangnum']=$projiangnum; //推广已发奖励金币
            $this->out_arr['prochart']=array($targetcopies,$propartnum!=0?$propartnum:0); //推广
         }else if($type==2){
            //参与任务数量
            $pushjoinnum=M("taskdraw")->where("f_taskid =".$taskid." and  f_utask_status=2")->count();
            //完成任务数量
            $compltenum=M("taskdraw")->where("f_taskid =".$taskid." and  f_utask_status=3")->count();
            //已发奖励金币
            $issued=$compltenum*$eachcoin;
            $this->out_arr['pushjoinnum']=$pushjoinnum!=0?$pushjoinnum:0; //随手参与任务数量
            $this->out_arr['compltenum']=$compltenum!=0?$compltenum:0; //完成任务数量
            $this->out_arr['issued']=$issued;  //已发奖励金币
            $this->out_arr["pushchart"]=array($targetcopies,$pushjoinnum!=0?$pushjoinnum:0,$compltenum!=0?$compltenum:0);//随手 
         }
         $this->pushConf();
     }
    function delteanswer(){
        $this->getConf();
        $indexid=$this->in_arr['indexid']; 
        $re=M("surveytaskdetail")->where("F_STDINDEX=".$indexid)->delete();
        if($re ==0){
            $this->out_arr['error_code']='false';
        }
        $this->out_arr['error_code']='true';
          $this->pushConf();
    }
    
    
   

    /******** 权限控制        用户->角色->权限 ***************/   
    /**
     * 添加角色
     * 表中对应的字段名
     */
    function role_add(){    	    	
    	$this->getConf();    	
    	$data = $this->in_arr;
    	$this->out_arr['code'] = M('role')->add($data); 
    	$this->pushConf();    	
    }
    
    // 编辑角色权限
    function  role_edit(){
       $this->getConf();    
       $id = $this->in_arr['id'];
       $access=$this->in_arr['access'];
       $this->out_arr['code']=M('role')->where('f_id='.$id)->setField('f_access',$access);
       $this->pushConf(); 
    }
    
    /**
     * 删除角色
     * f_id(角色的id)
     */
    function role_del(){
    	$this->getConf();
    	$id = $this->in_arr['f_id'];
        $re=M('user_role')->where("f_role_id")->count();
        if($re!=0){
            $this->out_arr['code']="false";
        }else{
            $this->out_arr['code'] = M('role')->delete($id);
        }
    	$this->pushConf();
    }    
    
    /**
     * 角色列表
     * page(第几页)
     */
    function role_list(){
    	$this->getConf();
    	$total = M('role')->count();//总记录数    	
        $pageSize = 10; //每页显示数
        $totalPage = ceil($total/$pageSize); //总页数
        $data=array("f_company_id=".$this->in_arr['companyid']);    
        $page = $this->in_arr['page'];
        if( $page == '' ){
        	$page = 0;
        }
        $list = M('role')->where($data)->page($page.','.$pageSize)->select();
        //echo M('role')->getLastSql();
        //构造数组
        $this->out_arr['list']=$list;
        $this->out_arr['page'] = $page;
        $this->out_arr['total'] = $total;
        $this->out_arr['pageSize'] = $pageSize;
        $this->out_arr['totalPage'] = $totalPage;    
    	$this->pushConf();
    }
    
    /**
     * 用户权限添加(调用用户模块组接口) 接口中的level
     * user_id(用户的id)  role_id(角色的id)
     */
    function power_add(){
    	$this->getConf();    	
    	$data = $this->in_arr;	    	
    	
    	$this->out_arr = M('user')->add($data);     	
    	$this->pushConf();  
    }

    /**
     * 添加到mysql数据库中，不调用接口
     * user_id(用户的id)  role_id(角色的id)
     */
    function power_add_local(){    	
        $this->getConf();       
        $data = $this->in_arr; 
        $this->out_arr = M('user_role')->add($data);  
        echo M('user_role')->getLastSql();
        exit;
        $this->pushConf();  
    }
    
    /**
     * 获取node列表 
     */
    function node_list(){
    	$this->getConf();    	
    	 
    	$this->out_arr['first'] = M('node')->where("`f_pid`=0")->select();
    	foreach( $this->out_arr['first'] as $key=>$vo ){
    		$this->out_arr['first'][$key]['child'] = M('node')->where("f_pid=".$vo['f_id'])->select();
    	}
        
    	return $this->out_arr;
    }

    /**
     * 下载APP
     */
  	function downApp(){
        $this->getConf();
        $map['f_udid'] = $this->in_arr['udid'];
        $map['f_ip'] = $this->getIP();
        $map['f_time'] = time();

        $re = M('downapp')->where("f_ip='".$map['f_ip']."'")->find();
        if(!$re){
            M('downapp')->add($map);
        }
        $link = "http://wisdom.51lick.com/Public/upfile/app/wisdom".$map['f_udid'].".apk";
        Header("HTTP/1.1 303 See Other");
        //header("Loaction:http://wisdom.51lick.com/Public/upfile/app/wisdom".$map['f_udid'].".apk");
        Header("Location:".$link);
    }

    // 定义一个函数getIP()
    function getIP(){
        global $ip;
        if (getenv("HTTP_CLIENT_IP"))
            $ip = getenv("HTTP_CLIENT_IP");
        else if(getenv("HTTP_X_FORWARDED_FOR"))
            $ip = getenv("HTTP_X_FORWARDED_FOR");
        else if(getenv("REMOTE_ADDR"))
            $ip = getenv("REMOTE_ADDR");
        else $ip = "Unknow";
        return $ip;
    }
    
    
    
}
